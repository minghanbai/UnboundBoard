<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Serverless Openboard</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; overflow: hidden; }
        #toolbar { padding: 10px; background: #eee; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; }
        #status { margin-left: auto; font-size: 0.9em; color: #666; }
        #canvas-container { flex: 1; background: #f8f9fa; position: relative; }
        button { cursor: pointer; padding: 5px 10px; }
        .active { background: #007bff; color: white; border: none; }
    </style>
</head>
<body>

<div id="toolbar">
    <button onclick="setMode('pencil')" id="btn-pencil">âœï¸ ç•«ç­†</button>
    <button onclick="setMode('select')" id="btn-select">ğŸ–ï¸ ç§»å‹•/é¸å–</button>
    <button onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©º</button>
    <button onclick="copyLink()" style="background: #28a745; color: white; border:none;">ğŸ”— è¤‡è£½åˆ†äº«é€£çµ</button>
    <span id="status">æ­£åœ¨é€£ç·š...</span>
</div>

<div id="canvas-container">
    <canvas id="c"></canvas>
</div>

<script>
    // --- 1. åˆå§‹åŒ– Fabric Canvas ---
    const canvas = new fabric.Canvas('c', {
        isDrawingMode: true
    });
    
    // èª¿æ•´ç•«å¸ƒå¤§å°ç‚ºå…¨è¢å¹•
    function resizeCanvas() {
        canvas.setWidth(window.innerWidth);
        canvas.setHeight(window.innerHeight - 50); // æ‰£æ‰ toolbar
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ç•«ç­†è¨­å®š
    canvas.freeDrawingBrush.width = 5;
    canvas.freeDrawingBrush.color = "black";

    // --- 2. ç‹€æ…‹è®Šæ•¸èˆ‡å·¥å…·å‡½æ•¸ ---
    let peer = null;
    let conn = null; // ç”¨æ–¼ Guest å­˜ Host çš„é€£ç·š
    let connections = []; // ç”¨æ–¼ Host å­˜æ‰€æœ‰ Guest çš„é€£ç·š
    let isHost = false;
    let isSyncing = false; // é˜²æ­¢è¿´åœˆæ›´æ–° (æ¥æ”¶æ•¸æ“šæ™‚ä¸è§¸ç™¼ç™¼é€)

    // å–å¾—ç¶²å€åƒæ•¸ ID
    const urlParams = new URLSearchParams(window.location.search);
    const targetPeerId = urlParams.get('id');

    // ç”Ÿæˆéš¨æ©Ÿ ID (å¦‚æœæ²’æœ‰ ID)
    function generateId() {
        return 'board-' + Math.random().toString(36).substr(2, 9);
    }

    // --- 3. PeerJS é€£ç·šé‚è¼¯ ---
    
    if (targetPeerId) {
        // === è¨ªå®¢æ¨¡å¼ (Guest) ===
        isHost = false;
        document.getElementById('status').innerText = "è¨ªå®¢æ¨¡å¼ï¼šæ­£åœ¨é€£ç·šåˆ°æˆ¿é–“...";
        
        // è¨ªå®¢ä¹Ÿéœ€è¦ä¸€å€‹ IDï¼Œä½†ä¸éœ€è¦å›ºå®š
        peer = new Peer(); 

        peer.on('open', (id) => {
            console.log('My Guest ID:', id);
            // é€£ç·šåˆ° Host
            conn = peer.connect(targetPeerId);

            conn.on('open', () => {
                document.getElementById('status').innerText = "âœ… å·²é€£ç·šåˆ°æˆ¿é–“";
                // é€£ç·šæˆåŠŸå¾Œï¼Œè«‹æ±‚ç›®å‰ç•«å¸ƒç‹€æ…‹
                conn.send({ type: 'REQUEST_INIT' });
            });

            conn.on('data', handleDataReceived);
            
            conn.on('error', (err) => {
                alert("é€£ç·šå¤±æ•—ï¼Œå¯èƒ½æˆ¿ä¸»å·²é›¢é–‹æˆ– ID éŒ¯èª¤");
            });
        });

    } else {
        // === æˆ¿ä¸»æ¨¡å¼ (Host) ===
        isHost = true;
        const myId = generateId();
        
        // ä½¿ç”¨ç‰¹å®š ID åˆå§‹åŒ–
        peer = new Peer(myId);

        peer.on('open', (id) => {
            document.getElementById('status').innerText = "ğŸ‘‘ æˆ¿ä¸»æ¨¡å¼ (ç­‰å¾…é€£ç·š)";
            // æ›´æ–°ç¶²å€ä½†ä¸é‡æ•´ï¼Œæ–¹ä¾¿è¤‡è£½
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + id;
            window.history.pushState({path:newUrl},'',newUrl);
        });

        peer.on('connection', (c) => {
            // ç•¶æœ‰äººé€£å…¥
            connections.push(c);
            document.getElementById('status').innerText = `ğŸ‘¥ ç›®å‰é€£ç·šäººæ•¸: ${connections.length}`;
            
            c.on('data', (data) => handleDataReceived(data, c));
            
            c.on('close', () => {
                connections = connections.filter(conn => conn !== c);
                document.getElementById('status').innerText = `ğŸ‘¥ ç›®å‰é€£ç·šäººæ•¸: ${connections.length}`;
            });
        });
    }

    peer.on('error', (err) => {
        console.error(err);
        if(err.type === 'unavailable-id') {
            alert("ID è¡çªï¼Œè«‹é‡æ–°æ•´ç†é é¢");
        }
    });

    // --- 4. æ•¸æ“šåŒæ­¥é‚è¼¯ (æ ¸å¿ƒ) ---

    // å‘é€æ•¸æ“š
    function broadcast(data, excludeConn = null) {
        if (isHost) {
            // æˆ¿ä¸»ï¼šç™¼é€çµ¦æ‰€æœ‰ Guest (é™¤äº†ä¾†æº)
            connections.forEach(c => {
                if (c !== excludeConn && c.open) {
                    c.send(data);
                }
            });
        } else if (conn && conn.open) {
            // è¨ªå®¢ï¼šåªç™¼é€çµ¦æˆ¿ä¸» (æˆ¿ä¸»æœƒå†è½‰ç™¼)
            conn.send(data);
        }
    }

    // è™•ç†æ¥æ”¶åˆ°çš„æ•¸æ“š
    function handleDataReceived(data, senderConn) {
        isSyncing = true; // é–å®šï¼Œé¿å…è§¸ç™¼ 'object:added' äº‹ä»¶é€ æˆç„¡é™è¿´åœˆ

        if (data.type === 'CANVAS_UPDATE') {
            canvas.loadFromJSON(data.content, () => {
                canvas.renderAll();
                isSyncing = false; 
            });
            
            // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œæ”¶åˆ° A çš„ç•«åœ–ï¼Œè¦è½‰ç™¼çµ¦ B, C, D...
            if (isHost) {
                broadcast(data, senderConn);
            }
        } 
        else if (data.type === 'REQUEST_INIT' && isHost) {
            // è¨ªå®¢å‰›é€²ä¾†ï¼Œæˆ¿ä¸»ç™¼é€ç•¶å‰å®Œæ•´ç‹€æ…‹
            senderConn.send({
                type: 'CANVAS_UPDATE',
                content: JSON.stringify(canvas)
            });
            isSyncing = false;
        }
        else if (data.type === 'CLEAR') {
            canvas.clear();
            canvas.backgroundColor = "#f8f9fa"; // ä¿æŒèƒŒæ™¯è‰²
            if (isHost) broadcast(data, senderConn);
            isSyncing = false;
        }
    }

    // --- 5. ç›£è½ç•«å¸ƒäº‹ä»¶ (è§¸ç™¼åŒæ­¥) ---
    
    const sendUpdate = () => {
        if (!isSyncing) {
            const json = JSON.stringify(canvas);
            broadcast({ type: 'CANVAS_UPDATE', content: json });
        }
    };

    // ç›£è½ç•«å®Œä¸€ç­†ã€ç‰©ä»¶ç§»å‹•ã€è®Šå½¢
    canvas.on('path:created', sendUpdate);
    canvas.on('object:modified', sendUpdate);
    
    // --- 6. UI åŠŸèƒ½ ---

    function setMode(mode) {
        if (mode === 'pencil') {
            canvas.isDrawingMode = true;
            document.getElementById('btn-pencil').classList.add('active');
            document.getElementById('btn-select').classList.remove('active');
        } else {
            canvas.isDrawingMode = false;
            document.getElementById('btn-pencil').classList.remove('active');
            document.getElementById('btn-select').classList.add('active');
        }
    }

    function clearCanvas() {
        canvas.clear();
        canvas.backgroundColor = "#f8f9fa"; // ä¿æŒèƒŒæ™¯è‰²
        broadcast({ type: 'CLEAR' });
    }

    function copyLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert("é€£çµå·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹å³å¯åŠ å…¥å”ä½œã€‚\n" + url);
        });
    }

    // åˆå§‹ UI ç‹€æ…‹
    setMode('pencil');

</script>
</body>
</html>
