<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Serverless Unbound Board</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; overflow: hidden; }
        #toolbar { padding: 10px; background: #eee; border-bottom: 1px solid #ccc; display: none; gap: 10px; align-items: center; }
        #status { margin-left: auto; font-size: 0.9em; color: #666; }
        #canvas-container { flex: 1; background: #f8f9fa; position: relative; }
        button { cursor: pointer; padding: 5px 10px; }
        .active { background: #007bff; color: white; border: none; }
        #overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; color: white; font-size: 1.5em;
            pointer-events: auto;
            backdrop-filter: blur(2px);
        }
        .hidden { display: none !important; pointer-events: none !important; }
        .tag { font-size: 0.8em; padding: 2px 5px; border-radius: 3px; color: white; margin-left: 5px; }
        .tag-host { background: #ffc107; color: black; }
        .tag-me { background: #28a745; }
        #side-panel {
            position: absolute; bottom: 10px; right: 10px;
            background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 320px; height: 450px; z-index: 900; border-radius: 5px;
            display: flex; flex-direction: column;
        }
        #panel-header { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; border-radius: 5px 5px 0 0; }
        .panel-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; color: #666; font-weight: bold; }
        .panel-tab.active { border-bottom: 2px solid #007bff; color: #007bff; background: white; }
        .panel-close { padding: 0 15px; border: none; background: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .tab-content { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        #chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #fff; }
        #chat-input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; background: #fff; }
        #chat-input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; background: #f0f2f5; outline: none; }
        #chat-input:focus { border-color: #007bff; background: #fff; }
        #btn-chat-send { border-radius: 20px !important; }
        
        .chat-msg { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 2px; }
        .chat-msg.self { align-self: flex-end; align-items: flex-end; }
        .chat-msg.other { align-self: flex-start; align-items: flex-start; }
        .chat-name { font-size: 0.75em; color: #65676b; margin-bottom: 4px; margin-left: 12px; }
        .chat-msg.self .chat-name { display: none; }
        .chat-bubble { padding: 8px 14px; border-radius: 18px; font-size: 0.95em; line-height: 1.4; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-msg.self .chat-bubble { background: #007bff; color: white; border-bottom-right-radius: 4px; }
        .chat-msg.other .chat-bubble { background: #f0f2f5; color: #050505; border-bottom-left-radius: 4px; }
        .has-unread { position: relative; }
        .has-unread::after { content: "â—"; color: red; position: absolute; top: 0; right: 0; font-size: 10px; }
        #user-list-content { flex: 1; overflow-y: auto; padding: 0; }
        .user-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #toast-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 2000; pointer-events: none;
        }
        .toast {
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 0.9em; animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        #landing-modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center; width: 300px;
        }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #666; font-weight: bold; }
        .input-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; }
        .primary-btn { background: #007bff; color: white; width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1.1em; cursor: pointer; }
        .secondary-btn { background: #6c757d; color: white; width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1.1em; cursor: pointer; margin-top: 5px;}
        .divider { margin: 20px 0; color: #999; font-size: 0.9em; position: relative; }
        .divider::before, .divider::after { content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background: #eee; }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        #context-menu {
            display: none; position: absolute; z-index: 3000; background: white; 
            border: 1px solid #ccc; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden;
        }
    </style>
</head>
<body>

<div id="toolbar">
    <button onclick="setMode('pencil')" id="btn-pencil">âœï¸ ç•«ç­†</button>
    <button onclick="setMode('eraser')" id="btn-eraser">ğŸ§½ æ©¡çš®æ“¦</button>
    <button onclick="setMode('select')" id="btn-select">ğŸ–ï¸ ç§»å‹•/é¸å–</button>
    <button onclick="toggleSettings()" id="btn-settings" style="display:none;">âš™ï¸ è¨­å®š</button>
    <button onclick="toggleHand()" id="btn-hand">âœ‹ èˆ‰æ‰‹</button>
    <button onclick="toggleSidePanel('users')" id="btn-users">ğŸ‘¥ æˆå“¡</button>
    <button onclick="toggleSidePanel('chat')" id="btn-chat">ğŸ’¬ èŠå¤©</button>
    <button onclick="addStickyNote()" id="btn-note">ğŸ“ ä¾¿æ¢ç´™</button>
    <button onclick="document.getElementById('img-upload').click()" id="btn-img">ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡</button>
    <input type="file" id="img-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
    <button onclick="document.getElementById('pdf-upload').click()" id="btn-pdf">ğŸ“„ ä¸Šå‚³ PDF</button>
    <input type="file" id="pdf-upload" accept="application/pdf" style="display: none;" onchange="handlePdfUpload(this)">
    <div id="pdf-controls" style="display:none; border-left: 1px solid #ccc; padding-left: 10px; margin-left: 10px; align-items: center; gap: 5px;">
        <button onclick="changePdfPage(-1)" class="host-only">â—€</button>
        <span id="pdf-page-indicator" style="font-size: 0.9em; font-weight: bold; color: #333;" class="host-only"></span>
        <button onclick="changePdfPage(1)" class="host-only">â–¶</button>
        <button onclick="zoomPdf(1.1)" title="æ”¾å¤§">â•</button>
        <button onclick="zoomPdf(0.9)" title="ç¸®å°">â–</button>
        <button onclick="fitPdfToWindow()" title="é©æ‡‰è¦–çª—">â¤¢</button>
        <button onclick="closePdfMode()" style="background:#dc3545; color:white; margin-left: 5px;" class="host-only">âœ– çµæŸ</button>
    </div>
    <button onclick="clearCanvas()" id="btn-clear">ğŸ—‘ï¸ æ¸…ç©º</button>
    <button onclick="copyLink()" style="background: #28a745; color: white; border:none;">ğŸ”— è¤‡è£½åˆ†äº«é€£çµ</button>
    <span id="status">æ­£åœ¨é€£ç·š...</span>
</div>

<div id="canvas-container">
    <canvas id="c"></canvas>
    <div id="overlay" class="hidden">
        <div id="overlay-msg">é€£ç·šä¸­...</div>
    </div>
    <div id="toast-container"></div>
    <div id="side-panel" class="hidden">
        <div id="panel-header">
            <div id="tab-chat" class="panel-tab active" onclick="switchTab('chat')">èŠå¤©å®¤</div>
            <div id="tab-users" class="panel-tab" onclick="switchTab('users')">æˆå“¡</div>
            <button class="panel-close" onclick="document.getElementById('side-panel').classList.add('hidden')">Ã—</button>
        </div>
        <div id="panel-chat" class="tab-content active">
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯...">
                <button onclick="sendChatMessage()" class="primary-btn" style="width:auto; padding: 5px 15px; font-size: 0.9em;" id="btn-chat-send">é€å‡º</button>
            </div>
        </div>
        <div id="panel-users" class="tab-content">
            <div id="user-list-content"></div>
        </div>
    </div>
    <div id="settings-modal" class="hidden" style="position: absolute; top: 50px; left: 10px; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px; width: 200px; z-index: 950; border-radius: 5px;">
        <h3 style="margin-top:0;">æˆ¿é–“è¨­å®š</h3>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-hand">å…è¨±èˆ‰æ‰‹</label>
            <input type="checkbox" id="setting-hand" checked onchange="updateSettings()">
        </div>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-chat">å…è¨±èŠå¤©</label>
            <input type="checkbox" id="setting-chat" checked onchange="updateSettings()">
        </div>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-edit">å…è¨±ç·¨è¼¯</label>
            <input type="checkbox" id="setting-edit" checked onchange="updateSettings()">
        </div>
        <button onclick="toggleSettings()" class="secondary-btn" style="font-size: 0.9em; padding: 5px;">é—œé–‰</button>
    </div>
    <div id="landing-modal" class="hidden">
        <div class="modal-content">
            <h2>Unbound Board</h2>
            <div class="input-group">
                <label>æ‚¨çš„æš±ç¨±</label>
                <input type="text" id="nickname-input" placeholder="è¼¸å…¥æš±ç¨±">
            </div>
            <div class="action-group">
                <button onclick="createRoom()" class="primary-btn">ğŸ  é–‹æ–°æˆ¿é–“</button>
            </div>
            <div class="divider">æˆ–è€…</div>
            <div class="input-group">
                <label>è¼¸å…¥æˆ¿é–“ä»£ç¢¼</label>
                <input type="text" id="room-code-input" placeholder="ä¾‹å¦‚: board-xyz...">
                <button onclick="joinRoomInput()" class="secondary-btn">â¡ï¸ åŠ å…¥æˆ¿é–“</button>
            </div>
        </div>
    </div>
</div>

<div id="context-menu">
    <div style="padding:8px 15px; cursor:pointer; font-size: 0.9em; color: #dc3545;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="deleteSelectedObject()">ğŸ—‘ï¸ åˆªé™¤</div>
</div>

<script>
    // è¨­å®š PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- 1. åˆå§‹åŒ– Fabric Canvas ---
    // å¼·åˆ¶è¦†å¯« getContextï¼Œç¢ºä¿ Fabric å…§éƒ¨å»ºç«‹çš„æ‰€æœ‰ Cache Canvas (æ©¡çš®æ“¦åµæ¸¬ç”¨) éƒ½å•Ÿç”¨ willReadFrequently
    const originalGetContext = HTMLCanvasElement.prototype.getContext;
    HTMLCanvasElement.prototype.getContext = function(type, attributes) {
        if (type === '2d') {
            attributes = attributes || {};
            attributes.willReadFrequently = true;
        }
        return originalGetContext.call(this, type, attributes);
    };

    const canvasEl = document.getElementById('c');
    const canvas = new fabric.Canvas(canvasEl, {
        isDrawingMode: true,
        fireRightClick: true, // å•Ÿç”¨å³éµé»æ“Šäº‹ä»¶
        stopContextMenu: true // é˜»æ­¢é è¨­é¸å–®
    });
    
    // ç¦ç”¨ç€è¦½å™¨é è¨­å³éµé¸å–®
    // å³éµé¸å–®è™•ç†
    canvas.upperCanvasEl.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        
        // æ‰‹å‹•åµæ¸¬æ»‘é¼ ä¸‹çš„ç‰©ä»¶ (å¿½ç•¥ evented å±¬æ€§ï¼Œç¢ºä¿æ©¡çš®æ“¦æ¨¡å¼ä¸‹ä¹Ÿèƒ½é¸å–åœ–ç‰‡)
        const pointer = canvas.getPointer(e);
        const objects = canvas.getObjects();
        let target = null;
        
        // å¾æœ€ä¸Šå±¤å¾€ä¸‹æ‰¾
        for (let i = objects.length - 1; i >= 0; i--) {
            if (objects[i].containsPoint(pointer)) {
                target = objects[i];
                break;
            }
        }
        
        if (target) {
            canvas.setActiveObject(target);
            canvas.renderAll();
            
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
        } else {
            document.getElementById('context-menu').style.display = 'none';
        }
    });
    
    // èª¿æ•´ç•«å¸ƒå¤§å°ç‚ºå…¨è¢å¹•
    function resizeCanvas() {
        canvas.setWidth(window.innerWidth);
        canvas.setHeight(window.innerHeight - document.getElementById('toolbar').offsetHeight); // æ‰£æ‰ toolbar
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ PDF èƒŒæ™¯ï¼Œè‹¥æœ‰å‰‡è‡ªé©æ‡‰è¦–çª—
        const bg = canvas.getObjects().find(o => o.isPdfBackground);
        if (bg) fitPdfToWindow(bg);
    }
    
    function fitPdfToWindow(bgImg) {
        if (!bgImg) bgImg = canvas.getObjects().find(o => o.isPdfBackground);
        if (!bgImg) return;

        // è¨­å®šèƒŒæ™¯è‰²ç‚ºæ·±ç°ï¼Œå€åˆ†ç•«å¸ƒèˆ‡ PDF
        canvas.backgroundColor = "#525659";

        // è¨­å®šè£åˆ‡å€åŸŸï¼Œé™åˆ¶ç·¨è¼¯ç¯„åœåœ¨ PDF é é¢å…§
        // ä½¿ç”¨çµ•å°å®šä½ï¼Œç¢ºä¿è£åˆ‡æ¡†å°æ‡‰åˆ° PDF åœ–ç‰‡çš„é‚è¼¯åº§æ¨™ (0,0)
        const clipRect = new fabric.Rect({
            left: bgImg.left,
            top: bgImg.top,
            width: bgImg.width * bgImg.scaleX,
            height: bgImg.height * bgImg.scaleY
        });
        canvas.clipPath = clipRect;

        const padding = 40; // ç•™ç™½
        const availableWidth = canvas.width - padding;
        const availableHeight = canvas.height - padding;
        
        // ä½¿ç”¨åœ–ç‰‡åŸå§‹å°ºå¯¸ (scaleX/Y æ‡‰ç‚º 1) è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
        const contentWidth = bgImg.width * bgImg.scaleX;
        const contentHeight = bgImg.height * bgImg.scaleY;

        // ä½¿ç”¨ Math.min ç¢ºä¿å®Œæ•´é¡¯ç¤º (Contain)ï¼Œè§£æ±ºç›´å‘ PDF åªé¡¯ç¤ºä¸ŠåŠéƒ¨çš„å•é¡Œ
        const zoom = Math.min(availableWidth / contentWidth, availableHeight / contentHeight);
        
        canvas.setZoom(zoom);
        
        // è¨­å®š Viewport å¹³ç§»ä»¥ç½®ä¸­
        const vpt = canvas.viewportTransform;
        vpt[4] = (canvas.width - contentWidth * zoom) / 2;
        vpt[5] = (canvas.height - contentHeight * zoom) / 2;
        canvas.requestRenderAll();
    }

    function zoomPdf(factor) {
        let zoom = canvas.getZoom();
        zoom *= factor;
        if (zoom > 5) zoom = 5;
        if (zoom < 0.1) zoom = 0.1;
        canvas.zoomToPoint(new fabric.Point(canvas.width / 2, canvas.height / 2), zoom);
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ç•«ç­†è¨­å®š
    canvas.freeDrawingBrush.width = 5;
    canvas.freeDrawingBrush.color = "black";

    // --- 2. ç‹€æ…‹è®Šæ•¸èˆ‡å·¥å…·å‡½æ•¸ ---
    let peer = null;
    let conn = null; // ç”¨æ–¼ Guest å­˜ Host çš„é€£ç·š
    let connections = []; // ç”¨æ–¼ Host å­˜æ‰€æœ‰ Guest çš„é€£ç·š
    let isHost = false;
    let isSyncing = false; // é˜²æ­¢è¿´åœˆæ›´æ–° (æ¥æ”¶æ•¸æ“šæ™‚ä¸è§¸ç™¼ç™¼é€)
    
    let myPeerId = null;
    let knownPeers = []; // è¿½è¹¤æˆ¿é–“å…§æ‰€æœ‰äººçš„ ID
    let isTempHost = false; // æ˜¯å¦ç‚ºè‡¨æ™‚æˆ¿ä¸»
    let lastHeartbeat = Date.now(); // å¿ƒè·³è¨ˆæ™‚
    let lastModified = 0; // ç•«å¸ƒæœ€å¾Œä¿®æ”¹æ™‚é–“ (åˆå§‹ç‚º 0ï¼Œé¿å…èª¤åˆ¤ç‚ºæœ€æ–°)
    let pendingAcks = new Map(); // è¿½è¹¤æœªç¢ºèªçš„æ›´æ–° (msgId -> timeout)
    let retryCount = 0; // é‡è©¦è¨ˆæ•¸
    let reconnectInterval = null; // é‡é€£è¿´åœˆè¨ˆæ™‚å™¨
    let myNickname = "Guest";
    let nicknames = {}; // ID -> Name
    let raisedHands = new Set(); // è¿½è¹¤èˆ‰æ‰‹çš„äºº
    let roomSettings = { allowRaiseHand: true, allowChat: true, allowEditing: true }; // æˆ¿é–“æ¬Šé™è¨­å®š
    
    // PDF ç°¡å ±æ¨¡å¼è®Šæ•¸
    let pdfImages = []; // å„²å­˜ PDF æ¯ä¸€é çš„åœ–ç‰‡ DataURL
    let pdfCanvasStates = []; // å„²å­˜æ¯ä¸€é çš„ Canvas JSON ç‹€æ…‹ (å¡—é´‰)
    let currentPdfPage = -1;
    let lastPdfSrc = null; // ç”¨æ–¼è¨ªå®¢ç«¯åˆ¤æ–·æ˜¯å¦æ›é 

    // UI æç¤ºèˆ‡é–å®šåŠŸèƒ½
    function setOverlay(show, msg = "") {
        const overlay = document.getElementById('overlay');
        const msgDiv = document.getElementById('overlay-msg');
        if (msg) msgDiv.innerText = msg;
        if (show) overlay.classList.remove('hidden');
        else overlay.classList.add('hidden');
    }

    // å–å¾—ç¶²å€åƒæ•¸ ID
    const urlParams = new URLSearchParams(window.location.search);
    let targetHostId = urlParams.get('id'); // æ”¹ç‚º let ä»¥ä¾¿è½‰ç§»æˆ¿ä¸»

    // ç”Ÿæˆéš¨æ©Ÿ ID (å¦‚æœæ²’æœ‰ ID)
    function generateId() {
        return 'board-' + Math.random().toString(36).substr(2, 9);
    }

    // æª¢æŸ¥æ˜¯å¦ç‚ºåŸæˆ¿ä¸» (å¾ LocalStorage åˆ¤æ–·)
    const lastHostId = localStorage.getItem('unbound_host_id');

    // --- æš±ç¨±èˆ‡æ­¡è¿é é¢é‚è¼¯ ---
    function generateNickname() {
        const adjectives = ['è¿…æ•', 'é–ƒé›»', 'å¿«æ¨‚', 'å¹¸é‹', 'å¤¢å¹»', 'é™½å…‰', 'æ´»åŠ›', 'æº«æŸ”', 'å‹‡æ•¢', 'è°æ˜', 'æ´»æ½‘', 'å¯æ„›', 'ç¥å¥‡', 'å„ªé›…', 'ç†±æƒ…'];
        const animals = ['è²“å’ª', 'ç‹—ç‹—', 'å…”å­', 'ç‹ç‹¸', 'ç†Šè²“', 'è€é·¹', 'ç…å­', 'è€è™', 'ä¼éµ', 'æµ·è±š', 'ç„¡å°¾ç†Š', 'è¢‹é¼ ', 'å°é¹¿', 'æ¾é¼ '];
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const animal = animals[Math.floor(Math.random() * animals.length)];
        return `${adj}${animal}`;
    }

    function createRoom() {
        const nameInput = document.getElementById('nickname-input').value.trim();
        myNickname = nameInput || generateNickname();
        document.getElementById('landing-modal').classList.add('hidden');
        document.getElementById('toolbar').style.display = 'flex';
        resizeCanvas();
        targetHostId = null; // ç¢ºä¿æ˜¯æ–°æˆ¿é–“
        initializePeer();
    }

    function joinRoomInput() {
        const code = document.getElementById('room-code-input').value.trim();
        if (!code) return alert("è«‹è¼¸å…¥æˆ¿é–“ä»£ç¢¼");
        const nameInput = document.getElementById('nickname-input').value.trim();
        myNickname = nameInput || generateNickname();
        targetHostId = code;
        document.getElementById('landing-modal').classList.add('hidden');
        document.getElementById('toolbar').style.display = 'flex';
        resizeCanvas();
        
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + targetHostId;
        window.history.pushState({path:newUrl},'',newUrl);
        
        initializePeer();
    }

    // --- 3. PeerJS é€£ç·šé‚è¼¯ ---
    
    function initializePeer(forceGuest = false) {
        if (peer) {
            peer.destroy();
            peer = null;
        }
        if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
        }

        const isReturningHost = !forceGuest && targetHostId && (targetHostId === lastHostId);

        if (targetHostId && !isReturningHost) {
            // === è¨ªå®¢æ¨¡å¼ ===
            isHost = false;
            peer = new Peer();
            setOverlay(true, "æ­£åœ¨åˆå§‹åŒ–é€£ç·š...");
        } else {
            // === æˆ¿ä¸»æ¨¡å¼ (æ–°å»ºæˆ–å›æ­¸) ===
            isHost = true;
            const idToUse = isReturningHost ? targetHostId : generateId();
            
            if (!isReturningHost) {
                localStorage.setItem('unbound_host_id', idToUse);
                // lastModified ä¿æŒç‚º 0
            }
            
            peer = new Peer(idToUse);
        }

        bindPeerEvents(isReturningHost);
        applyRoomSettings(); // åˆå§‹åŒ–æ™‚å¥—ç”¨è¨­å®š (ä¸»è¦æ˜¯éš±è—è¨­å®šæŒ‰éˆ•)
    }

    function bindPeerEvents(isReturningHost) {
        peer.on('open', (id) => {
            myPeerId = id;
            console.log('My ID:', id);
            nicknames[id] = myNickname; // è¨˜éŒ„è‡ªå·±çš„æš±ç¨±
            retryCount = 0; // é€£ç·šæˆåŠŸï¼Œé‡ç½®è¨ˆæ•¸

            if (isHost) {
                // å˜—è©¦æ¢å¾©ä¹‹å‰çš„ç•«å¸ƒç‹€æ…‹
                const savedState = localStorage.getItem('unbound_board_state');
                const savedTime = localStorage.getItem('unbound_last_modified');
                if (savedState) {
                    canvas.loadFromJSON(savedState, () => canvas.renderAll());
                }
                if (savedTime) {
                    lastModified = parseInt(savedTime);
                }

                // å¦‚æœæ˜¯æˆ¿ä¸»å›æ­¸ï¼Œå…ˆé–å®šç•«é¢ï¼Œç­‰å¾…è‡¨æ™‚æˆ¿ä¸»å›å‚³æœ€æ–°é€²åº¦
                if (isReturningHost) {
                    setOverlay(true, "æ­£åœ¨ç­‰å¾…åŒæ­¥æœ€æ–°ç‹€æ…‹...");
                    // è¨­å®š 4 ç§’è¶…æ™‚ï¼Œå¦‚æœæ²’äººå‚³æ–°è³‡æ–™çµ¦æˆ‘å€‘ï¼Œå°±å‡è¨­æˆ‘å€‘æ˜¯æœ€æ–°çš„ä¸¦è§£é–
                    setTimeout(() => {
                        const msgDiv = document.getElementById('overlay-msg');
                        if (msgDiv && msgDiv.innerText === "æ­£åœ¨ç­‰å¾…åŒæ­¥æœ€æ–°ç‹€æ…‹...") {
                            setOverlay(false);
                        }
                    }, 4000);
                }

                document.getElementById('status').innerText = "ğŸ‘‘ æˆ¿ä¸»æ¨¡å¼ (ç­‰å¾…é€£ç·š)";
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + id;
                window.history.pushState({path:newUrl},'',newUrl);
            } else {
                connectToHost(targetHostId);
                startReconnectLoop(); // å•Ÿå‹•èƒŒæ™¯é‡é€£æ©Ÿåˆ¶
            }
        });

        // ç›£è½é€£å…¥ (æˆ¿ä¸»ã€è‡¨æ™‚æˆ¿ä¸»éƒ½æœƒç”¨åˆ°)
        peer.on('connection', (c) => {
            c.on('open', () => {
                connections.push(c);
                updateStatus();
                
                // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»(æˆ–è‡¨æ™‚)ï¼Œå»£æ’­æœ€æ–°çš„ Peer List å’Œç•«å¸ƒ
                if (isHost) {
                    broadcastPeerList();
                    c.send({ type: 'CANVAS_UPDATE', content: JSON.stringify(canvas), timestamp: lastModified, settings: roomSettings });
                }
            });

            c.on('data', (data) => handleDataReceived(data, c));
            
            c.on('close', () => {
                connections = connections.filter(conn => conn !== c);
                updateStatus();
                renderUserList(); // æ›´æ–°åå–®
                if (isHost) broadcastPeerList();
            });
        });

        peer.on('error', (err) => {
            console.error(err);
            if(err.type === 'unavailable-id') {
                if (isHost && isReturningHost) {
                    if (retryCount < 3) {
                        retryCount++;
                        setOverlay(true, `ID ä½”ç”¨ä¸­ï¼Œæ­£åœ¨é‡è©¦ (${retryCount}/3)...`);
                        setTimeout(() => initializePeer(false), 1500);
                    } else {
                        alert("ç„¡æ³•å–å¾—æˆ¿ä¸»æ¬Šé™ (ID ä»è¢«ä½”ç”¨)ï¼Œå°‡è½‰ç‚ºè¨ªå®¢æ¨¡å¼ã€‚");
                        initializePeer(true); // å¼·åˆ¶è½‰ç‚ºè¨ªå®¢
                    }
                } else {
                    alert("ID è¡çªï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                }
            }
        });
    }

    // å•Ÿå‹• Peer
    if (targetHostId) {
        // æœ‰ ID (åˆ†äº«é€£çµé€²å…¥)ï¼Œç›´æ¥åˆå§‹åŒ–
        myNickname = generateNickname(); // è‡ªå‹•åˆ†é…æš±ç¨±
        document.getElementById('toolbar').style.display = 'flex';
        resizeCanvas();
        initializePeer();
    } else {
        // ç„¡ ID (ç›´æ¥é€²å…¥é¦–é )ï¼Œé¡¯ç¤ºç™»å…¥ Modal
        document.getElementById('landing-modal').classList.remove('hidden');
        document.getElementById('nickname-input').value = generateNickname(); // é å¡«æš±ç¨±
    }

    function connectToHost(hostId) {
        setOverlay(true, "æ­£åœ¨é€£ç·šåˆ°: " + hostId);
        document.getElementById('status').innerText = "æ­£åœ¨é€£ç·šåˆ°: " + hostId;
        
        // æ¸…ç†èˆŠé€£ç·šèˆ‡æœªå®Œæˆçš„ ACK
        if (conn) {
            conn.off('close'); // ç§»é™¤ç›£è½ï¼Œé¿å…æ‰‹å‹•åˆ‡æ›æ™‚è§¸ç™¼æ–·ç·šé‚è¼¯
            conn.close();
        }
        pendingAcks.forEach(t => clearTimeout(t));
        pendingAcks.clear();
        
        conn = peer.connect(hostId);
        
        conn.on('open', () => {
            setOverlay(false);
            document.getElementById('status').innerText = "âœ… å·²é€£ç·š";
            lastHeartbeat = Date.now(); // é‡ç½®å¿ƒè·³
            conn.send({ type: 'REQUEST_INIT' });
            conn.send({ type: 'HELLO', nickname: myNickname }); // ç™¼é€æš±ç¨±
        });

        conn.on('data', (data) => handleDataReceived(data, conn));
        
        conn.on('close', () => {
            setOverlay(true, "âŒ é€£ç·šä¸­æ–·");
            document.getElementById('status').innerText = "âŒ é€£ç·šä¸­æ–·";
            handleHostDisconnect();
        });
    }

    // è™•ç†æˆ¿ä¸»æ–·ç·šï¼šå°‹æ‰¾å‚™ç”¨æˆ¿ä¸»
    function handleHostDisconnect() {
        // 1. å¦‚æœå·²ç¶“æˆåŠŸé€£å›åŸæˆ¿ä¸»ï¼Œå¿½ç•¥èˆŠé€£ç·šçš„æ–·ç·šäº‹ä»¶
        if (conn && conn.open && conn.peer === targetHostId) return;
        
        if (isHost && !isTempHost) return; // åŸæˆ¿ä¸»æœ¬äººä¸éœ€è¦è™•ç†

        console.log("Host disconnected. Finding backup...");
        setOverlay(true, "é€£ç·šä¸­æ–·ï¼Œæ­£åœ¨å°‹æ‰¾å‚™ç”¨æˆ¿ä¸»...");
        
        // æ’é™¤åŸæˆ¿ä¸»å’Œè‡ªå·±ï¼Œå‰©ä¸‹çš„ ID æ’åº
        const candidates = knownPeers.filter(p => p !== targetHostId && p !== myPeerId).sort();
        
        // å¦‚æœæˆ‘æ˜¯å€™é¸äººä¸­ ID æœ€å°çš„ (æˆ–æ˜¯å”¯ä¸€å‰©ä¸‹çš„)ï¼Œæˆ‘æˆç‚ºè‡¨æ™‚æˆ¿ä¸»
        if (candidates.length === 0 || myPeerId < candidates[0]) {
            console.log("Becoming Temp Host");
            isTempHost = true;
            isHost = true;
            
            // æˆç‚ºæˆ¿ä¸»å¾Œï¼Œæ¸…é™¤æ‰€æœ‰ç­‰å¾…ä¸­çš„ ACK
            pendingAcks.forEach(t => clearTimeout(t));
            pendingAcks.clear();
            
            setOverlay(false); // æˆç‚ºè‡¨æ™‚æˆ¿ä¸»ï¼Œè§£é™¤é–å®š
            updateStatus();
            // 2. ç«‹å³å°å·²é€£ä¸Šçš„è¨ªå®¢é€²è¡ŒåŒæ­¥ (è§£æ±ºç«¶æ…‹æ¢ä»¶å°è‡´çš„åŒæ­¥éºå¤±)
            connections.forEach(c => {
                if (c.open) {
                    c.send({ type: 'CANVAS_UPDATE', content: JSON.stringify(canvas), timestamp: lastModified });
                    c.send({ type: 'CANVAS_UPDATE', content: JSON.stringify(canvas.toJSON(['isPdfBackground'])), timestamp: lastModified });
                }
            });
            broadcastPeerList();
        } else {
            // å¦å‰‡é€£ç·šçµ¦å‚™ç”¨æˆ¿ä¸»
            console.log("Connecting to Backup:", candidates[0]);
            connectToHost(candidates[0]);
        }
    }

    // èƒŒæ™¯æ©Ÿåˆ¶ï¼šæŒçºŒå˜—è©¦é€£å›åŸæˆ¿ä¸»
    function startReconnectLoop() {
        if (reconnectInterval) clearInterval(reconnectInterval);
        reconnectInterval = setInterval(() => {
            // å¦‚æœå·²ç¶“é€£ä¸ŠåŸæˆ¿ä¸»ï¼Œä»€éº¼éƒ½ä¸åš
            if (conn && conn.peer === targetHostId && conn.open) return;
            
            const rConn = peer.connect(targetHostId);
            rConn.on('open', () => {
                console.log("Original Host is back!");
                lastHeartbeat = Date.now(); // é‡ç½®å¿ƒè·³
                // å¦‚æœæˆ‘æ˜¯è‡¨æ™‚æˆ¿ä¸»ï¼ŒæŠŠæœ€æ–°ç‹€æ…‹å‚³å›å»
                if (isTempHost) {
                    rConn.send({ type: 'CANVAS_UPDATE', content: JSON.stringify(canvas), timestamp: lastModified });
                    rConn.send({ type: 'CANVAS_UPDATE', content: JSON.stringify(canvas.toJSON(['isPdfBackground'])), timestamp: lastModified });
                    
                    // å…ˆå¸ä»»ï¼Œé¿å…å¾ŒçºŒé‚è¼¯è¡çª
                    isTempHost = false;
                    isHost = false;
                    
                    // æ–·é–‹æ‰€æœ‰è‡¨æ™‚é€£ç·šï¼Œè®“ä»–å€‘è‡ªå·±é‡é€£å›åŸæˆ¿ä¸»
                    connections.forEach(c => c.close());
                    connections = [];
                }
                
                // åˆ‡æ›å›åŸæˆ¿ä¸» (å…ˆæ›´æ–°åƒç…§å†é—œé–‰èˆŠé€£ç·šï¼Œé¿å…è§¸ç™¼ handleHostDisconnect çš„èª¤åˆ¤)
                const oldConn = conn;
                conn = rConn; 
                if (oldConn) oldConn.close();
                
                // æ¸…é™¤èˆŠçš„ ACK ç­‰å¾…
                pendingAcks.forEach(t => clearTimeout(t));
                pendingAcks.clear();
                isSyncing = false; // é‡é€£å¾Œå¼·åˆ¶è§£é–åŒæ­¥ç‹€æ…‹ï¼Œé¿å…å¡æ­»

                setOverlay(false); // è§£é™¤é–å®š
                updateStatus(); // æ›´æ–°ç‹€æ…‹æ–‡å­—ä¸¦é‡ç¹ªåå–® (ç§»é™¤è½‰ç§»æŒ‰éˆ•)
                
                // é‡æ–°ç¶å®šäº‹ä»¶
                conn.on('data', (data) => handleDataReceived(data, conn));
                conn.on('close', () => {
                    setOverlay(true, "âŒ é€£ç·šä¸­æ–·");
                    document.getElementById('status').innerText = "âŒ é€£ç·šä¸­æ–·";
                    handleHostDisconnect();
                });
                
                // ä¸»å‹•è«‹æ±‚æœ€æ–°ç‹€æ…‹
                conn.send({ type: 'REQUEST_INIT' });
                conn.send({ type: 'HELLO', nickname: myNickname }); // è£œç™¼æš±ç¨±
            });
        }, 5000); // æ¯ 5 ç§’å˜—è©¦ä¸€æ¬¡
    }

    // --- 4. æ•¸æ“šåŒæ­¥é‚è¼¯ (æ ¸å¿ƒ) ---

    // å‘é€æ•¸æ“š
    function broadcast(data, excludeConn = null) {
        if (isHost) {
            // æˆ¿ä¸»ï¼šç™¼é€çµ¦æ‰€æœ‰ Guest (é™¤äº†ä¾†æº)
            connections.forEach(c => {
                if (c !== excludeConn && c.open) {
                    c.send(data);
                }
            });
        } else if (conn && conn.open) {
            // è¨ªå®¢ï¼šåªç™¼é€çµ¦æˆ¿ä¸» (æˆ¿ä¸»æœƒå†è½‰ç™¼)
            conn.send(data);
        } else if (conn && !conn.open) {
            console.warn("ç„¡æ³•ç™¼é€æ•¸æ“šï¼šé€£ç·šæœªé–‹å•Ÿ");
            // å¦‚æœé€£ç·šå­˜åœ¨ä½†æœªé–‹å•Ÿï¼Œå¯èƒ½éœ€è¦æç¤ºæˆ–è™•ç†
            setOverlay(true, "âš ï¸ é€£ç·šä¸­æ–·ï¼Œæ­£åœ¨å˜—è©¦æ¢å¾©...");
            conn.close(); // è§¸ç™¼é‡é€£é‚è¼¯
        }
    }

    // è™•ç†æ¥æ”¶åˆ°çš„æ•¸æ“š
    function handleDataReceived(data, senderConn) {
        if (data.type === 'HEARTBEAT') {
            lastHeartbeat = Date.now();
            return;
        }

        if (data.type === 'HELLO') {
            nicknames[senderConn.peer] = data.nickname;
            if (isHost) broadcastPeerList(); // æˆ¿ä¸»æ”¶åˆ°æ–°æš±ç¨±å¾Œå»£æ’­æ›´æ–°
        }
        
        if (data.type === 'UPDATE_ACK') {
            if (pendingAcks.has(data.msgId)) {
                clearTimeout(pendingAcks.get(data.msgId));
                pendingAcks.delete(data.msgId);
            }
            return;
        }
        
        if (data.type === 'CHAT') {
            const senderName = data.nickname || "Unknown";
            appendChatMessage(senderName, data.message, false);
            
            if (isHost) {
                broadcast(data, senderConn);
            }

            const panel = document.getElementById('side-panel');
            if (panel.classList.contains('hidden') || activeTab !== 'chat') {
                document.getElementById('btn-chat').classList.add('has-unread');
                if (!panel.classList.contains('hidden')) document.getElementById('tab-chat').classList.add('has-unread');
            }
        }

        if (data.type === 'RAISE_HAND') {
            raisedHands.add(data.peerId);
            const name = data.nickname || nicknames[data.peerId] || "æŸäºº";
            nicknames[data.peerId] = name; // ç¢ºä¿æš±ç¨±åŒæ­¥
            showToast(`âœ‹ ${name} èˆ‰æ‰‹äº†ï¼`);
            renderUserList();
            if (isHost) broadcast(data, senderConn);
        }

        if (data.type === 'LOWER_HAND') {
            if (data.peerId === 'ALL') {
                raisedHands.clear();
                showToast(`æˆ¿ä¸»æ”¾ä¸‹äº†æ‰€æœ‰äººçš„æ‰‹`);
            } else {
                raisedHands.delete(data.peerId);
                // å¦‚æœæ˜¯æ”¾ä¸‹è‡ªå·±çš„æ‰‹ï¼Œä¸ä¸€å®šè¦é¡¯ç¤º Toastï¼Œé¿å…å¤ªåµ
                // ä½†å¦‚æœæ˜¯æˆ¿ä¸»æ”¾ä¸‹åˆ¥äººçš„æ‰‹ï¼Œå¯ä»¥é¡¯ç¤ºä¸€ä¸‹
                // é€™è£¡ç°¡å–®è™•ç†ï¼Œåªæ›´æ–°åˆ—è¡¨
            }
            renderUserList();
            if (isHost) broadcast(data, senderConn);
        }

        if (data.type === 'ROOM_SETTINGS_UPDATE') {
            roomSettings = data.settings;
            applyRoomSettings();
            if (isHost) broadcast(data, senderConn); // è‡¨æ™‚æˆ¿ä¸»å¯èƒ½éœ€è¦è½‰ç™¼? é€šå¸¸åªæœ‰æˆ¿ä¸»ç™¼é€
        }

        if (data.type === 'CANVAS_UPDATE') {
            // è¡çªè§£æ±ºï¼šå¦‚æœæ”¶åˆ°çš„æ•¸æ“šæ˜é¡¯æ¯”æœ¬åœ°èˆŠ (å®¹è¨± 2 ç§’èª¤å·®)ï¼Œå‰‡å¿½ç•¥ä¸¦å›å‚³æœ¬åœ°æ–°ç‰ˆ
            if (data.timestamp && data.timestamp < lastModified - 2000) {
                console.log("æ”¶åˆ°èˆŠæ•¸æ“šï¼Œå¿½ç•¥ä¸¦å›å‚³æœ¬åœ°æ–°ç‰ˆ");
                // åŠ ä¸Š msgId ç¢ºä¿æˆ¿ä¸»æœƒå›å‚³ ACKï¼Œä¸¦è¦–ç‚ºæ­£å¼æ›´æ–°
                senderConn.send({
                    type: 'CANVAS_UPDATE',
                    content: JSON.stringify(canvas),
                    content: JSON.stringify(canvas.toJSON(['isPdfBackground'])),
                    timestamp: lastModified,
                    msgId: Date.now() + '-rev-' + Math.random().toString(36).substr(2, 9)
                });
                return;
            }

            if (data.timestamp) lastModified = data.timestamp;

            if (data.settings) {
                roomSettings = data.settings;
                applyRoomSettings();
            }

            isSyncing = true; // é–å®šï¼Œé¿å…è§¸ç™¼ 'object:added' äº‹ä»¶
            // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œæ”¶åˆ°è¨ªå®¢æ›´æ–°éœ€å›è¦† ACK
            if (isHost && data.msgId) {
                senderConn.send({ type: 'UPDATE_ACK', msgId: data.msgId });
            }

            canvas.loadFromJSON(data.content, () => {
                canvas.renderAll();
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ PDF èƒŒæ™¯
                const bg = canvas.getObjects().find(o => o.isPdfBackground);
                
                if (bg) {
                    // å¼·åˆ¶é–å®š PDF èƒŒæ™¯ï¼Œé˜²æ­¢ç§»å‹•æˆ–ç·¨è¼¯
                    bg.set({ selectable: false, evented: false });
                    // é¡¯ç¤º PDF æ§åˆ¶é …
                    document.getElementById('pdf-controls').style.display = 'flex';
                    // æ ¹æ“šèº«åˆ†éš±è—/é¡¯ç¤ºç‰¹å®šæŒ‰éˆ•
                    document.querySelectorAll('#pdf-controls .host-only').forEach(el => {
                        el.style.display = isHost ? 'inline-block' : 'none';
                    });

                    // æ™ºæ…§ç¸®æ”¾ï¼šåªæœ‰åœ¨ã€Œåˆæ¬¡è¼‰å…¥ã€æˆ–ã€Œåˆ‡æ›é é¢ã€æ™‚æ‰å¼·åˆ¶é©æ‡‰è¦–çª—
                    // è‹¥åªæ˜¯ç­†è·¡æ›´æ–°ï¼Œå‰‡ä¿ç•™è¨ªå®¢ç•¶å‰çš„ç¸®æ”¾ç‹€æ…‹
                    const currentSrc = bg.getSrc();
                    if (currentSrc !== lastPdfSrc) {
                        fitPdfToWindow(bg);
                        lastPdfSrc = currentSrc;
                    }
                } else {
                    document.getElementById('pdf-controls').style.display = 'none';
                    lastPdfSrc = null;
                }
                
                isSyncing = false; 
                if (isHost) {
                    localStorage.setItem('unbound_board_state', data.content);
                    localStorage.setItem('unbound_last_modified', lastModified);
                    setOverlay(false); // æ”¶åˆ°æ›´æ–°è³‡æ–™å¾Œï¼Œè§£é™¤é–å®š
                }
            });
            
            // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œæ”¶åˆ° A çš„ç•«åœ–ï¼Œè¦è½‰ç™¼çµ¦ B, C, D...
            if (isHost) {
                broadcast(data, senderConn);
            }
        }
        else if (data.type === 'PEER_LIST') {
            // æ›´æ–°åœ¨ç·šåå–®
            knownPeers = data.peers;
            if (data.raisedHands) raisedHands = new Set(data.raisedHands); // åŒæ­¥èˆ‰æ‰‹ç‹€æ…‹
            if (data.nicknames) nicknames = data.nicknames; // åŒæ­¥æš±ç¨±è¡¨
            renderUserList(); // æ”¶åˆ°æ–°åå–®å¾Œç«‹å³åˆ·æ–°ä»‹é¢
        }
        else if (data.type === 'REQUEST_INIT') {
            // æ”¶åˆ°è«‹æ±‚ (ä¾†è‡ªæ–°è¨ªå®¢æˆ–å›æ­¸çš„åŸæˆ¿ä¸»)
            if (isHost) {
            senderConn.send({
                type: 'CANVAS_UPDATE',
                content: JSON.stringify(canvas),
                content: JSON.stringify(canvas.toJSON(['isPdfBackground'])),
                timestamp: lastModified,
                settings: roomSettings
            });
            broadcastPeerList();
            }
        }
        else if (data.type === 'CLEAR') {
            isSyncing = true; // é–å®š
            canvas.clear();
            canvas.backgroundColor = "#f8f9fa"; // ä¿æŒèƒŒæ™¯è‰²
            canvas.setZoom(1);
            canvas.viewportTransform = [1, 0, 0, 1, 0, 0];
            if (isHost) localStorage.removeItem('unbound_board_state');
            if (isHost) localStorage.removeItem('unbound_last_modified');
            if (isHost) broadcast(data, senderConn);
            isSyncing = false;
        }
        else if (data.type === 'KICK') {
            alert("æ‚¨å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“ã€‚");
            window.location.href = window.location.pathname; // å›åˆ°é¦–é 
            return;
        }
        else if (data.type === 'HOST_CHANGED') {
            // æˆ¿ä¸»å·²è½‰ç§»
            console.log("Host changed to:", data.newHostId);
            targetHostId = data.newHostId;
            
            // æ›´æ–°ç¶²å€
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + targetHostId;
            window.history.pushState({path:newUrl},'',newUrl);

            if (myPeerId === targetHostId) {
                // æˆ‘æ˜¯æ–°æˆ¿ä¸»
                isHost = true;
                localStorage.setItem('unbound_host_id', myPeerId); // è¨˜ä½æˆ‘æ˜¯æ–°æˆ¿ä¸»
                updateStatus();
            } else {
                // æˆ‘æ˜¯è¨ªå®¢ï¼Œé€£ç·šåˆ°æ–°æˆ¿ä¸»
                connectToHost(targetHostId);
            }
        }
    }

    function broadcastPeerList() {
        const list = connections.map(c => c.peer);
        list.push(myPeerId);
        knownPeers = list; // æˆ¿ä¸»ä¹Ÿè¦æ›´æ–°è‡ªå·±çš„åå–®
        broadcast({ type: 'PEER_LIST', peers: list, nicknames: nicknames, raisedHands: Array.from(raisedHands) });
        renderUserList(); // æˆ¿ä¸»åˆ·æ–°ä»‹é¢
    }

    function updateStatus() {
        const role = isTempHost ? "âš ï¸ è‡¨æ™‚æˆ¿ä¸»" : (isHost ? "ğŸ‘‘ æˆ¿ä¸»" : "è¨ªå®¢");
        document.getElementById('status').innerText = `${role} | ç·šä¸Š: ${connections.length + (isHost?0:1)}`;
        renderUserList();
        applyRoomSettings(); // æ¬Šé™è®Šæ›´æ™‚é‡æ–°å¥—ç”¨è¨­å®š
    }

    // --- 5. ç›£è½ç•«å¸ƒäº‹ä»¶ (è§¸ç™¼åŒæ­¥) ---
    
    const sendUpdate = (arg) => {
        if (!isSyncing) {
            const json = JSON.stringify(canvas.toJSON(['isPdfBackground']));
            lastModified = Date.now(); // æ›´æ–°æ™‚é–“æˆ³
            if (isHost) localStorage.setItem('unbound_board_state', json);
            if (isHost) localStorage.setItem('unbound_last_modified', lastModified);
            
            const payload = { type: 'CANVAS_UPDATE', content: json, timestamp: lastModified };
            
            if (!isHost) {
                // è¨ªå®¢å¢åŠ  ACK ç¢ºèªæ©Ÿåˆ¶
                const msgId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                payload.msgId = msgId;
                
                // å‹•æ…‹è¨ˆç®—è¶…æ™‚æ™‚é–“ï¼šåŸºç¤ 600ms + æ¯ 1KB å¢åŠ  2ms
                // é€™æ¨£ç¹ªåœ–ï¼ˆæ•¸æ“šå°ï¼‰æœƒå¾ˆå¿«åµæ¸¬æ–·ç·šï¼Œåœ–ç‰‡ï¼ˆæ•¸æ“šå¤§ï¼‰æœƒçµ¦äºˆæ›´å¤šå¯¬é™æ™‚é–“
                let timeoutDuration = 600 + (json.length / 500);
                
                // å¦‚æœæœ‰å‚³å…¥æ˜ç¢ºçš„æ•¸å€¼ (ä¾‹å¦‚ä¸Šå‚³åœ–ç‰‡æ™‚å¼·åˆ¶æŒ‡å®š)ï¼Œå‰‡å–è¼ƒå¤§è€…
                if (typeof arg === 'number') {
                    timeoutDuration = Math.max(timeoutDuration, arg);
                }

                const timeout = setTimeout(() => {
                    if (pendingAcks.has(msgId)) {
                        console.warn("åŒæ­¥é€¾æ™‚ï¼Œæˆ¿ä¸»ç„¡å›æ‡‰:", msgId);
                        setOverlay(true, "âš ï¸ åŒæ­¥å¤±æ•—ï¼Œæ­£åœ¨é‡é€£...");
                        if (conn) conn.close(); // å¼·åˆ¶æ–·ç·šä»¥è§¸ç™¼é‡é€£é‚è¼¯
                        pendingAcks.delete(msgId);
                    }
                }, timeoutDuration); 
                pendingAcks.set(msgId, timeout);
            }
            
            broadcast(payload);
        }
    };

    // ç›£è½ç•«å®Œä¸€ç­†ã€ç‰©ä»¶ç§»å‹•ã€è®Šå½¢
    canvas.on('path:created', sendUpdate);
    canvas.on('object:modified', sendUpdate);
    canvas.on('object:removed', sendUpdate);
    canvas.on('text:editing:exited', sendUpdate);
    
    // --- 6. UI åŠŸèƒ½ ---

    let currentMode = 'pencil';
    let isMouseDown = false;

    function setMode(mode) {
        // å¦‚æœä¸æ˜¯æˆ¿ä¸»ä¸”è¢«ç¦æ­¢ç·¨è¼¯ï¼Œå‰‡ç„¡æ³•åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
        if (!isHost && !roomSettings.allowEditing && mode !== 'select') return;

        currentMode = mode;
        
        // é‡ç½®æŒ‰éˆ•æ¨£å¼
        document.getElementById('btn-pencil').classList.remove('active');
        document.getElementById('btn-select').classList.remove('active');
        document.getElementById('btn-eraser').classList.remove('active');
        
        // é‡ç½® Canvas ç‹€æ…‹
        canvas.isDrawingMode = false;
        canvas.selection = false;
        canvas.defaultCursor = 'default';
        canvas.forEachObject(o => {
            // ç¢ºä¿ PDF èƒŒæ™¯æ°¸é é–å®šï¼Œä¸å—æ¨¡å¼åˆ‡æ›å½±éŸ¿
            if (o.isPdfBackground) {
                o.selectable = false;
                o.evented = false;
            } else {
                o.selectable = true;
                o.perPixelTargetFind = false; // é è¨­ä½¿ç”¨ Bounding Boxï¼Œæ–¹ä¾¿é¸å–
                o.evented = true; // æ¢å¾©äº‹ä»¶éŸ¿æ‡‰
            }
        });

        if (mode === 'pencil') {
            canvas.isDrawingMode = true;
            document.getElementById('btn-pencil').classList.add('active');
        } 
        else if (mode === 'select') {
            document.getElementById('btn-select').classList.add('active');
            canvas.selection = true;
        }
        else if (mode === 'eraser') {
            document.getElementById('btn-eraser').classList.add('active');
            canvas.defaultCursor = 'crosshair';
            canvas.forEachObject(o => {
                o.selectable = false;
                if (o.type === 'path') {
                    o.perPixelTargetFind = true; // é–‹å•Ÿåƒç´ ç´šåµæ¸¬ï¼Œåªåœ¨ç¢°åˆ°ç·šæ¢æ™‚è§¸ç™¼
                    o.targetFindTolerance = 4;   // å¢åŠ ä¸€é»å®¹éŒ¯ç¯„åœï¼Œè®“ç´°ç·šæ¯”è¼ƒå¥½æ“¦
                } else {
                    // åœ–ç‰‡ã€PDF ç­‰éè·¯å¾‘ç‰©ä»¶ï¼Œåœ¨æ©¡çš®æ“¦æ¨¡å¼ä¸‹ä¸æ¥æ”¶äº‹ä»¶
                    o.evented = false;
                }
            });
            canvas.discardActiveObject();
            canvas.requestRenderAll();
        }
    }

    // æ©¡çš®æ“¦äº‹ä»¶ç›£è½
    canvas.on('mouse:down', (opt) => {
        isMouseDown = true;
        
        let target = opt.target;
        // å¦‚æœåœ¨ç•«ç­†æ¨¡å¼ä¸‹ï¼Œå³éµé»æ“Šä¸æœƒè‡ªå‹•åµæ¸¬ targetï¼Œéœ€æ‰‹å‹•åµæ¸¬
        if (opt.button === 3 && !target && canvas.isDrawingMode) {
            target = canvas.findTarget(opt.e);
        }
        // é»æ“Šç•«å¸ƒæ™‚éš±è—é¸å–®
        document.getElementById('context-menu').style.display = 'none';

        // å³éµé¸å–® (Button 3)
        if (opt.button === 3 && target) {
            canvas.setActiveObject(target);
            canvas.renderAll();
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = opt.e.clientX + 'px';
            menu.style.top = opt.e.clientY + 'px';
            return;
        } else {
            document.getElementById('context-menu').style.display = 'none';
        }

        if (currentMode === 'eraser' && opt.target && opt.target.type === 'path') {
            canvas.remove(opt.target);
        }
    });
    canvas.on('mouse:up', () => {
        isMouseDown = false;
    });
    canvas.on('mouse:move', (opt) => {
        if (currentMode === 'eraser' && isMouseDown && opt.target && opt.target.type === 'path') {
            canvas.remove(opt.target);
        }
    });

    function addStickyNote() {
        if (!isHost && !roomSettings.allowEditing) return;
        const note = new fabric.Textbox('é›™æ“Šç·¨è¼¯', {
            left: Math.random() * (canvas.width - 200) + 50,
            top: Math.random() * (canvas.height - 200) + 50,
            width: 150,
            fontSize: 20,
            backgroundColor: '#ffeb3b', // é»ƒè‰²ä¾¿æ¢ç´™
            splitByGrapheme: true
        });
        canvas.add(note);
        canvas.setActiveObject(note);
        setMode('select'); // åˆ‡æ›åˆ°é¸å–æ¨¡å¼ä»¥ä¾¿ç·¨è¼¯
        sendUpdate();
    }

    // --- åˆªé™¤åŠŸèƒ½ (éµç›¤èˆ‡å³éµ) ---
    function deleteSelectedObject() {
        if (!isHost && !roomSettings.allowEditing) return;
        const activeObjects = canvas.getActiveObjects();
        if (activeObjects.length) {
            // é˜²æ­¢åˆªé™¤æ­£åœ¨ç·¨è¼¯ä¸­çš„æ–‡å­—
            if (activeObjects[0].isEditing) return;

            canvas.discardActiveObject();
            activeObjects.forEach(obj => {
                canvas.remove(obj);
            });
            canvas.requestRenderAll();
            sendUpdate();
        }
        document.getElementById('context-menu').style.display = 'none';
    }

    window.addEventListener('keydown', (e) => {
        const activeEl = document.activeElement;
        const isInput = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
        if ((e.key === 'Delete' || e.key === 'Backspace') && !isInput) {
            deleteSelectedObject();
        }
    });

    function handleImageUpload(input) {
        if (!isHost && !roomSettings.allowEditing) return;
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            fabric.Image.fromURL(e.target.result, function(img) {
                // é™åˆ¶åœ–ç‰‡åˆå§‹å¤§å°ï¼Œé¿å…éå¤§ä½”æ»¿è¢å¹•
                const maxSize = 300;
                const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
                
                img.set({
                    left: Math.random() * (canvas.width - 200) + 50,
                    top: Math.random() * (canvas.height - 200) + 50,
                    scaleX: scale,
                    scaleY: scale
                });
                canvas.add(img);
                canvas.setActiveObject(img);
                setMode('select'); // è‡ªå‹•åˆ‡æ›åˆ°é¸å–æ¨¡å¼
                sendUpdate(3000); // åœ–ç‰‡è¼ƒå¤§ï¼Œçµ¦äºˆ 3 ç§’å¯¬é™
            });
        };
        reader.readAsDataURL(file);
        input.value = ''; // æ¸…ç©ºä»¥å…è¨±é‡è¤‡ä¸Šå‚³ç›¸åŒæª”æ¡ˆ
    }

    // --- PDF ç°¡å ±æ¨¡å¼é‚è¼¯ ---
    
    function changePdfPage(offset) {
        const newIndex = currentPdfPage + offset;
        if (newIndex < 0 || newIndex >= pdfImages.length) return;

        // 1. å„²å­˜ç•¶å‰é é¢çš„ç‹€æ…‹ (åŒ…å«å¡—é´‰)
        if (currentPdfPage >= 0) {
            pdfCanvasStates[currentPdfPage] = JSON.stringify(canvas);
            pdfCanvasStates[currentPdfPage] = JSON.stringify(canvas.toJSON(['isPdfBackground']));
        }

        // 2. åˆ‡æ›é é¢ç´¢å¼•
        currentPdfPage = newIndex;
        loadPdfPage();
    }

    function loadPdfPage() {
        // æ›´æ–° UI
        document.getElementById('pdf-page-indicator').innerText = `${currentPdfPage + 1} / ${pdfImages.length}`;

        // é–å®šåŒæ­¥ï¼Œé¿å…è¼‰å…¥éç¨‹è§¸ç™¼å¤šæ¬¡æ›´æ–°
        isSyncing = true;

        const onLoaded = () => {
            isSyncing = false;
            sendUpdate(); // è¼‰å…¥å®Œæˆå¾Œï¼Œç™¼é€ä¸€æ¬¡æ›´æ–°çµ¦æ‰€æœ‰è¨ªå®¢
        };

        if (pdfCanvasStates[currentPdfPage]) {
            // A. å¦‚æœé€™é å·²ç¶“æœ‰å­˜æª” (æœ‰å¡—é´‰é)ï¼Œç›´æ¥è¼‰å…¥å­˜æª”
            canvas.loadFromJSON(pdfCanvasStates[currentPdfPage], () => {
                // è¼‰å…¥å¾Œé‡æ–°é©æ‡‰è¦–çª—
                fitPdfToWindow();
                onLoaded();
            });
        } else {
            // B. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é€²å…¥é€™é ï¼Œè¼‰å…¥ PDF åœ–ç‰‡ä¸¦è¨­ç‚ºèƒŒæ™¯(æˆ–åº•å±¤ç‰©ä»¶)
            canvas.clear();
            canvas.backgroundColor = "#f8f9fa";
            // é‡ç½®è¦–åœ–
            canvas.setZoom(1);
            canvas.viewportTransform = [1, 0, 0, 1, 0, 0];
            
            fabric.Image.fromURL(pdfImages[currentPdfPage], function(img) {
                img.set({
                    left: 0,
                    top: 0,
                    originX: 'left',
                    originY: 'top',
                    scaleX: 1,
                    scaleY: 1,
                    selectable: false, // é–å®šï¼Œç•¶ä½œèƒŒæ™¯
                    evented: false,
                    isPdfBackground: true // æ¨™è¨˜ç‚º PDF èƒŒæ™¯
                });
                canvas.add(img);
                canvas.sendToBack(img); // ç¢ºä¿åœ¨æœ€åº•å±¤
                fitPdfToWindow(img); // é©æ‡‰è¦–çª—
                onLoaded();
            });
        }
    }

    function closePdfMode() {
        if (!confirm("ç¢ºå®šè¦çµæŸ PDF ç°¡å ±æ¨¡å¼å—ï¼Ÿé€™å°‡æœƒæ¸…ç©ºç›®å‰çš„ç•«å¸ƒã€‚")) return;
        pdfImages = [];
        pdfCanvasStates = [];
        currentPdfPage = -1;
        document.getElementById('pdf-controls').style.display = 'none';
        // æ¢å¾©ä¸€èˆ¬æŒ‰éˆ•
        document.getElementById('btn-pdf').style.display = 'inline-block';
        document.getElementById('btn-img').style.display = 'inline-block';
        
        // é‡ç½®è¦–åœ–
        canvas.setZoom(1);
        canvas.viewportTransform = [1, 0, 0, 1, 0, 0];
        canvas.clipPath = null; // æ¸…é™¤è£åˆ‡
        clearCanvas();
    }

    async function handlePdfUpload(input) {
        if (!isHost && !roomSettings.allowEditing) return;
        const file = input.files[0];
        if (!file) return;

        setOverlay(true, "æ­£åœ¨è™•ç† PDF...");
        
        // é‡ç½® PDF ç‹€æ…‹
        pdfImages = [];
        pdfCanvasStates = [];
        currentPdfPage = -1;

        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 }); // æå‡è§£æåº¦
                const canvasTmp = document.createElement('canvas');
                const context = canvasTmp.getContext('2d');
                canvasTmp.height = viewport.height;
                canvasTmp.width = viewport.width;
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                pdfImages.push(canvasTmp.toDataURL('image/jpeg', 0.8)); // è½‰å­˜ç‚ºåœ–ç‰‡
            }
            
            // é€²å…¥ç°¡å ±æ¨¡å¼
            document.getElementById('pdf-controls').style.display = 'flex';
            // éš±è—éƒ¨åˆ†æŒ‰éˆ•ä»¥ç¯€çœç©ºé–“ (å¯é¸)
            // document.getElementById('btn-pdf').style.display = 'none';
            
            changePdfPage(1); // è¼‰å…¥ç¬¬ä¸€é  (currentPdfPage -1 + 1 = 0)
            setMode('select');
        } catch (err) {
            console.error(err);
            alert("PDF è™•ç†å¤±æ•—");
        } finally {
            setOverlay(false);
            input.value = '';
        }
    }

    function clearCanvas() {
        if (!isHost && !roomSettings.allowEditing) return;
        canvas.clear();
        canvas.backgroundColor = "#f8f9fa"; // ä¿æŒèƒŒæ™¯è‰²
        canvas.setZoom(1);
        canvas.viewportTransform = [1, 0, 0, 1, 0, 0];
        lastModified = Date.now(); // æ¸…ç©ºä¹Ÿç®—ä¸€ç¨®ä¿®æ”¹
        if (isHost) localStorage.removeItem('unbound_board_state');
        broadcast({ type: 'CLEAR' });
    }

    function copyLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert("é€£çµå·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹å³å¯åŠ å…¥å”ä½œã€‚\n" + url);
        });
    }

    // --- 8. æˆå“¡åå–®èˆ‡æˆ¿ä¸»è½‰ç§» ---
    // (toggleUserList å·²ç§»é™¤ï¼Œæ”¹ç”¨ toggleSidePanel)

    function renderUserList() {
        const container = document.getElementById('user-list-content');
        container.innerHTML = ''; // æ¸…ç©ºå…§å®¹

        // æ›´æ–°èˆ‰æ‰‹æŒ‰éˆ•ç‹€æ…‹ (åæ˜ èˆ‰æ‰‹/æ”¾ä¸‹å…©å€‹ç‹€æ…‹)
        const btnHand = document.getElementById('btn-hand');
        if (raisedHands.has(myPeerId)) {
            btnHand.innerText = "ğŸ™Œ æ”¾ä¸‹";
            btnHand.classList.add('active');
        } else {
            btnHand.innerText = "âœ‹ èˆ‰æ‰‹";
            btnHand.classList.remove('active');
        }

        // æˆ¿ä¸»åŠŸèƒ½ï¼šå…¨éƒ¨æ”¾ä¸‹
        if (isHost && raisedHands.size > 0) {
            const lowerAllBtn = document.createElement('button');
            lowerAllBtn.innerText = "ğŸ™Œ å…¨éƒ¨æ”¾ä¸‹";
            lowerAllBtn.className = "secondary-btn";
            lowerAllBtn.style.margin = "10px";
            lowerAllBtn.style.width = "calc(100% - 20px)";
            lowerAllBtn.style.padding = "5px";
            lowerAllBtn.onclick = () => lowerHand('ALL');
            container.appendChild(lowerAllBtn);
        }
        
        // ç¢ºä¿åå–®åŒ…å«è‡ªå·±
        let allPeers = [...knownPeers];
        if (!allPeers.includes(myPeerId)) allPeers.push(myPeerId);
        
        // æ’åºï¼šæˆ¿ä¸»æœ€å‰ï¼Œè‡ªå·±æ¬¡ä¹‹
        allPeers.sort((a, b) => {
            if (a === targetHostId) return -1;
            if (b === targetHostId) return 1;
            if (a === myPeerId) return -1;
            return 0;
        });

        allPeers.forEach(pid => {
            const div = document.createElement('div');
            div.className = 'user-item';
            const displayName = nicknames[pid] || pid.substr(0, 8);
            let html = `<span>${displayName}`;
            if (pid === targetHostId) html += `<span class="tag tag-host">æˆ¿ä¸»</span>`;
            if (pid === myPeerId) html += `<span class="tag tag-me">æˆ‘</span>`;
            
            // é¡¯ç¤ºèˆ‰æ‰‹åœ–ç¤º
            if (raisedHands.has(pid)) {
                html += ` <span style="font-size:1.2em;">âœ‹</span>`;
            }
            html += `</span>`;
            
            html += `<div style="display:flex; gap:5px;">`;
            // æˆ¿ä¸»åŠŸèƒ½ï¼šæ”¾ä¸‹æ‰‹
            if (isHost && raisedHands.has(pid)) {
                html += `<button onclick="lowerHand('${pid}')" style="font-size:0.8em; padding:2px 5px;">æ”¾ä¸‹</button>`;
            }
            // æˆ¿ä¸»åŠŸèƒ½ï¼šè½‰ç§»æ¬Šé™ (ä¸èƒ½è½‰çµ¦è‡ªå·±)
            if (isHost && pid !== myPeerId) {
                html += `<button onclick="transferHost('${pid}')" style="font-size:0.8em; padding:2px 5px;">ğŸ‘‘ è½‰ç§»</button>`;
                html += `<button onclick="kickMember('${pid}')" style="font-size:0.8em; padding:2px 5px; margin-left: 5px; background-color: #dc3545; color: white; border: none; border-radius: 3px;">ğŸš« è¸¢å‡º</button>`;
            }
            html += `</div>`;

            div.innerHTML = html;
            container.appendChild(div);
        });
    }

    function transferHost(newHostId) {
        if (!confirm("ç¢ºå®šè¦å°‡æˆ¿ä¸»æ¬Šé™è½‰ç§»çµ¦é€™ä½ä½¿ç”¨è€…å—ï¼Ÿ")) return;
        
        // å»£æ’­æ–°æˆ¿ä¸» ID
        broadcast({ type: 'HOST_CHANGED', newHostId: newHostId });
        
        // è‡ªå·±é™ç´šç‚ºè¨ªå®¢ä¸¦é€£ç·š
        isHost = false;
        targetHostId = newHostId;
        localStorage.removeItem('unbound_host_id'); // ç§»é™¤æˆ¿ä¸»ç´€éŒ„
        
        // æ›´æ–°ç¶²å€
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + targetHostId;
        window.history.pushState({path:newUrl},'',newUrl);
        
        connectToHost(targetHostId);
    }

    function kickMember(targetId) {
        if (!confirm("ç¢ºå®šè¦è¸¢å‡ºé€™ä½æˆå“¡å—ï¼Ÿ")) return;
        
        const connToKick = connections.find(c => c.peer === targetId);
        if (connToKick) {
            connToKick.send({ type: 'KICK' });
            // å»¶é²é—œé–‰é€£ç·šï¼Œç¢ºä¿è¨Šæ¯é€å‡º
            setTimeout(() => connToKick.close(), 500);
        }
    }

    // --- èˆ‰æ‰‹åŠŸèƒ½ ---
    function toggleHand() {
        if (!isHost && !roomSettings.allowRaiseHand) return alert("æˆ¿ä¸»å·²é—œé–‰èˆ‰æ‰‹åŠŸèƒ½");
        // å¦‚æœå·²ç¶“èˆ‰æ‰‹ï¼Œå‰‡æ”¾ä¸‹ (Toggle)
        if (raisedHands.has(myPeerId)) {
            const data = { type: 'LOWER_HAND', peerId: myPeerId };
            handleDataReceived(data, null); // æœ¬åœ°æ›´æ–°
            broadcast(data);
        } else {
            const data = { type: 'RAISE_HAND', peerId: myPeerId, nickname: myNickname };
            handleDataReceived(data, null); // æœ¬åœ°æ›´æ–°
            broadcast(data);
        }
    }

    function lowerHand(targetId) {
        // åƒ…æˆ¿ä¸»å¯å‘¼å«æ­¤å‡½å¼ä¾†æ”¾ä¸‹åˆ¥äººçš„æ‰‹
        const data = { type: 'LOWER_HAND', peerId: targetId };
        handleDataReceived(data, null); // æœ¬åœ°æ›´æ–°
        broadcast(data);
    }

    function showToast(msg) {
        const container = document.getElementById('toast-container');
        const div = document.createElement('div');
        div.className = 'toast';
        div.innerText = msg;
        container.appendChild(div);
        // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
        setTimeout(() => {
            div.style.opacity = '0';
            setTimeout(() => div.remove(), 500);
        }, 3000);
    }

    // --- 9. èŠå¤©å®¤åŠŸèƒ½ ---
    let activeTab = 'chat';

    function toggleSidePanel(tab) {
        const panel = document.getElementById('side-panel');
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            switchTab(tab);
        } else {
            if (activeTab === tab) {
                panel.classList.add('hidden');
            } else {
                switchTab(tab);
            }
        }
    }

    function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('panel-' + tab).classList.add('active');

        if (tab === 'chat') {
            document.getElementById('btn-chat').classList.remove('has-unread');
            document.getElementById('tab-chat').classList.remove('has-unread');
            setTimeout(() => document.getElementById('chat-input').focus(), 100);
        }
    }

    function sendChatMessage() {
        if (!isHost && !roomSettings.allowChat) return alert("æˆ¿ä¸»å·²é—œé–‰èŠå¤©åŠŸèƒ½");
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;

        const data = {
            type: 'CHAT',
            message: message,
            senderId: myPeerId,
            nickname: myNickname,
            timestamp: Date.now()
        };

        appendChatMessage(myNickname, message, true);
        broadcast(data);
        input.value = '';
    }

    function appendChatMessage(senderName, message, isSelf) {
        const history = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = isSelf ? 'chat-msg self' : 'chat-msg other';
        
        const nameSpan = document.createElement('div');
        nameSpan.className = 'chat-name';
        nameSpan.innerText = senderName;
        
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        bubble.innerText = message;

        div.appendChild(nameSpan);
        div.appendChild(bubble);
        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
    }

    // Bind Enter key
    document.getElementById('chat-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });

    // --- 10. æˆ¿é–“è¨­å®šåŠŸèƒ½ ---
    function toggleSettings() {
        const modal = document.getElementById('settings-modal');
        modal.classList.toggle('hidden');
        // åŒæ­¥ UI ç‹€æ…‹
        document.getElementById('setting-hand').checked = roomSettings.allowRaiseHand;
        document.getElementById('setting-chat').checked = roomSettings.allowChat;
        document.getElementById('setting-edit').checked = roomSettings.allowEditing;
    }

    function updateSettings() {
        if (!isHost) return;
        roomSettings.allowRaiseHand = document.getElementById('setting-hand').checked;
        roomSettings.allowChat = document.getElementById('setting-chat').checked;
        roomSettings.allowEditing = document.getElementById('setting-edit').checked;
        
        broadcast({ type: 'ROOM_SETTINGS_UPDATE', settings: roomSettings });
        applyRoomSettings(); // æˆ¿ä¸»è‡ªå·±ä¹Ÿè¦æ›´æ–° UI (é›–ç„¶æˆ¿ä¸»ä¸å—é™ï¼Œä½†å¯èƒ½éœ€è¦è¦–è¦ºå›é¥‹æˆ–ä¿æŒä¸€è‡´)
    }

    function applyRoomSettings() {
        // 1. è¨­å®šæŒ‰éˆ•å¯è¦‹æ€§ (åƒ…æˆ¿ä¸»å¯è¦‹)
        const btnSettings = document.getElementById('btn-settings');
        if (isHost) {
            btnSettings.style.display = 'inline-block';
        } else {
            btnSettings.style.display = 'none';
            document.getElementById('settings-modal').classList.add('hidden'); // å¼·åˆ¶é—œé–‰è¨­å®šè¦–çª—
        }

        // 2. æ ¹æ“šèº«åˆ†èˆ‡è¨­å®šå¥—ç”¨é™åˆ¶
        // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½å•Ÿç”¨ (å¿½ç•¥ roomSettings)
        // å¦‚æœæ˜¯è¨ªå®¢ï¼Œå‰‡ä¾æ“š roomSettings
        const canEdit = isHost || roomSettings.allowEditing;
        const canChat = isHost || roomSettings.allowChat;
        const canHand = isHost || roomSettings.allowRaiseHand;

        // ç·¨è¼¯æ¬Šé™æ§åˆ¶
        const editBtns = ['btn-pencil', 'btn-eraser', 'btn-select', 'btn-note', 'btn-img', 'btn-pdf', 'btn-clear'];
        editBtns.forEach(id => {
            const btn = document.getElementById(id);
            if(btn) btn.disabled = !canEdit;
        });

        if (!canEdit) {
            // å¼·åˆ¶é€€å‡ºç·¨è¼¯æ¨¡å¼
            canvas.isDrawingMode = false;
            canvas.selection = false;
            canvas.forEachObject(o => o.selectable = false);
            canvas.discardActiveObject();
            canvas.requestRenderAll();
            document.getElementById('btn-pencil').classList.remove('active');
            document.getElementById('btn-eraser').classList.remove('active');
            document.getElementById('btn-select').classList.remove('active');
        }

        // èŠå¤©èˆ‡èˆ‰æ‰‹æŒ‰éˆ•æ§åˆ¶
        document.getElementById('btn-chat-send').disabled = !canChat;
        document.getElementById('btn-hand').disabled = !canHand;
    }

    // åˆå§‹ UI ç‹€æ…‹
    setMode('pencil');

    // --- 7. å¿ƒè·³æ©Ÿåˆ¶ (Heartbeat) ---
    setInterval(() => {
        if (isHost) {
            // æˆ¿ä¸»ï¼šå®šæœŸç™¼é€å¿ƒè·³
            broadcast({ type: 'HEARTBEAT' });
        } else {
            // è¨ªå®¢ï¼šæª¢æŸ¥å¿ƒè·³æ˜¯å¦è¶…æ™‚
            if (conn && conn.open) {
                // å¦‚æœè¶…é 5 ç§’æ²’æ”¶åˆ°å¿ƒè·³ï¼Œåˆ¤å®šæ–·ç·š
                if (Date.now() - lastHeartbeat > 5000) {
                    console.warn("å¿ƒè·³è¶…æ™‚ï¼Œåˆ¤å®šæˆ¿ä¸»æ–·ç·š");
                    setOverlay(true, "âš ï¸ é€£ç·šä¸ç©©å®šï¼Œå˜—è©¦é‡é€£ä¸­...");
                    conn.close(); // é€™æœƒè§¸ç™¼ conn.on('close') -> handleHostDisconnect
                }
            }
        }
    }, 2000); // æ¯ 2 ç§’æª¢æŸ¥ä¸€æ¬¡

</script>
</body>
</html>
