<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Serverless Unbound Board</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; overflow: hidden; }
        #toolbar { padding: 10px; background: #eee; border-bottom: 1px solid #ccc; display: none; gap: 10px; align-items: center; }
        #status { margin-left: auto; font-size: 0.9em; color: #666; }
        #canvas-container { flex: 1; background: #f8f9fa; position: relative; }
        button { cursor: pointer; padding: 5px 10px; }
        .active { background: #007bff; color: white; border: none; }
        #overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; color: white; font-size: 1.5em;
            pointer-events: auto;
            backdrop-filter: blur(2px);
        }
        .hidden { display: none !important; pointer-events: none !important; }
        .tag { font-size: 0.8em; padding: 2px 5px; border-radius: 3px; color: white; margin-left: 5px; }
        .tag-host { background: #ffc107; color: black; }
        .tag-me { background: #28a745; }
        #side-panel {
            position: absolute; bottom: 10px; right: 10px;
            background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 320px; height: 450px; z-index: 900; border-radius: 5px;
            display: flex; flex-direction: column;
        }
        #panel-header { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; border-radius: 5px 5px 0 0; }
        .panel-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; color: #666; font-weight: bold; }
        .panel-tab.active { border-bottom: 2px solid #007bff; color: #007bff; background: white; }
        .panel-close { padding: 0 15px; border: none; background: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .tab-content { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        #chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #fff; }
        #chat-input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; background: #fff; }
        #chat-input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; background: #f0f2f5; outline: none; }
        #chat-input:focus { border-color: #007bff; background: #fff; }
        #btn-chat-send { border-radius: 20px !important; }
        
        .chat-msg { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 2px; }
        .chat-msg.self { align-self: flex-end; align-items: flex-end; }
        .chat-msg.other { align-self: flex-start; align-items: flex-start; }
        .chat-name { font-size: 0.75em; color: #65676b; margin-bottom: 4px; margin-left: 12px; }
        .chat-msg.self .chat-name { display: none; }
        .chat-bubble { padding: 8px 14px; border-radius: 18px; font-size: 0.95em; line-height: 1.4; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-msg.self .chat-bubble { background: #007bff; color: white; border-bottom-right-radius: 4px; }
        .chat-msg.other .chat-bubble { background: #f0f2f5; color: #050505; border-bottom-left-radius: 4px; }
        .has-unread { position: relative; }
        .has-unread::after { content: "â—"; color: red; position: absolute; top: 0; right: 0; font-size: 10px; }
        #user-list-content { flex: 1; overflow-y: auto; padding: 0; }
        .user-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #toast-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 2000; pointer-events: none;
        }
        .toast {
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 0.9em; animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        #landing-modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center; width: 300px;
        }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #666; font-weight: bold; }
        .input-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; }
        .primary-btn { background: #007bff; color: white; width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1.1em; cursor: pointer; }
        .secondary-btn { background: #6c757d; color: white; width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1.1em; cursor: pointer; margin-top: 5px;}
        .divider { margin: 20px 0; color: #999; font-size: 0.9em; position: relative; }
        .divider::before, .divider::after { content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background: #eee; }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        #context-menu {
            display: none; position: absolute; z-index: 3000; background: white; 
            border: 1px solid #ccc; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden;
        }
    </style>
</head>
<body>

<div id="toolbar">
    <button onclick="setMode('pencil')" id="btn-pencil">âœï¸ ç•«ç­†</button>
    <button onclick="setMode('eraser')" id="btn-eraser">ğŸ§½ æ©¡çš®æ“¦</button>
    <button onclick="setMode('select')" id="btn-select">ğŸ–ï¸ ç§»å‹•/é¸å–</button>
    <button onclick="toggleSettings()" id="btn-settings" style="display:none;">âš™ï¸ è¨­å®š</button>
    <button onclick="toggleHand()" id="btn-hand">âœ‹ èˆ‰æ‰‹</button>
    <button onclick="toggleSidePanel('users')" id="btn-users">ğŸ‘¥ æˆå“¡</button>
    <button onclick="toggleSidePanel('chat')" id="btn-chat">ğŸ’¬ èŠå¤©</button>
    <button onclick="addStickyNote()" id="btn-note">ğŸ“ ä¾¿æ¢ç´™</button>
    <button onclick="document.getElementById('img-upload').click()" id="btn-img">ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡</button>
    <input type="file" id="img-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
    <button onclick="document.getElementById('pdf-upload').click()" id="btn-pdf">ğŸ“„ ä¸Šå‚³ PDF</button>
    <input type="file" id="pdf-upload" accept="application/pdf" style="display: none;" onchange="handlePdfUpload(this)">
    <div id="pdf-controls" style="display:none; border-left: 1px solid #ccc; padding-left: 10px; margin-left: 10px; align-items: center; gap: 5px;">
        <button onclick="changePdfPage(-1)" class="host-only">â—€</button>
        <span id="pdf-page-indicator" style="font-size: 0.9em; font-weight: bold; color: #333;" class="host-only"></span>
        <button onclick="changePdfPage(1)" class="host-only">â–¶</button>
        <button onclick="zoomPdf(1.1)" title="æ”¾å¤§">â•</button>
        <button onclick="zoomPdf(0.9)" title="ç¸®å°">â–</button>
        <button onclick="fitPdfToWindow()" title="é©æ‡‰è¦–çª—">â¤¢</button>
        <button onclick="closePdfMode()" style="background:#dc3545; color:white; margin-left: 5px;" class="host-only">âœ– çµæŸ</button>
    </div>
    <button onclick="clearCanvas()" id="btn-clear">ğŸ—‘ï¸ æ¸…ç©º</button>
    <button onclick="copyLink()" style="background: #28a745; color: white; border:none;">ğŸ”— è¤‡è£½åˆ†äº«é€£çµ</button>
    <span id="status">æ­£åœ¨é€£ç·š...</span>
</div>

<div id="canvas-container">
    <canvas id="c"></canvas>
    <div id="overlay" class="hidden">
        <div id="overlay-msg">é€£ç·šä¸­...</div>
    </div>
    <div id="toast-container"></div>
    <div id="side-panel" class="hidden">
        <div id="panel-header">
            <div id="tab-chat" class="panel-tab active" onclick="switchTab('chat')">èŠå¤©å®¤</div>
            <div id="tab-users" class="panel-tab" onclick="switchTab('users')">æˆå“¡</div>
            <button class="panel-close" onclick="document.getElementById('side-panel').classList.add('hidden')">Ã—</button>
        </div>
        <div id="panel-chat" class="tab-content active">
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯...">
                <button onclick="sendChatMessage()" class="primary-btn" style="width:auto; padding: 5px 15px; font-size: 0.9em;" id="btn-chat-send">é€å‡º</button>
            </div>
        </div>
        <div id="panel-users" class="tab-content">
            <div id="user-list-content"></div>
        </div>
    </div>
    <div id="settings-modal" class="hidden" style="position: absolute; top: 50px; left: 10px; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px; width: 200px; z-index: 950; border-radius: 5px;">
        <h3 style="margin-top:0;">æˆ¿é–“è¨­å®š</h3>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-hand">å…è¨±èˆ‰æ‰‹</label>
            <input type="checkbox" id="setting-hand" checked onchange="updateSettings()">
        </div>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-chat">å…è¨±èŠå¤©</label>
            <input type="checkbox" id="setting-chat" checked onchange="updateSettings()">
        </div>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-edit">å…è¨±ç·¨è¼¯</label>
            <input type="checkbox" id="setting-edit" checked onchange="updateSettings()">
        </div>
        <button onclick="toggleSettings()" class="secondary-btn" style="font-size: 0.9em; padding: 5px;">é—œé–‰</button>
    </div>
    <div id="landing-modal" class="hidden">
        <div class="modal-content">
            <h2>Unbound Board</h2>
            <div class="input-group">
                <label>æ‚¨çš„æš±ç¨±</label>
                <input type="text" id="nickname-input" placeholder="è¼¸å…¥æš±ç¨±">
            </div>
            <div class="action-group">
                <button onclick="createRoom()" class="primary-btn">ğŸ  é–‹æ–°æˆ¿é–“</button>
            </div>
            <div class="divider">æˆ–è€…</div>
            <div class="input-group">
                <label>è¼¸å…¥æˆ¿é–“ä»£ç¢¼</label>
                <input type="text" id="room-code-input" placeholder="ä¾‹å¦‚: board-xyz...">
                <button onclick="joinRoomInput()" class="secondary-btn">â¡ï¸ åŠ å…¥æˆ¿é–“</button>
            </div>
        </div>
    </div>
</div>

<div id="context-menu">
    <div style="padding:8px 15px; cursor:pointer; font-size: 0.9em; color: #dc3545;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="deleteSelectedObject()">ğŸ—‘ï¸ åˆªé™¤</div>
</div>
<script src="globals.js"></script>
<script src="drawing.js"></script>
<script src="connection.js"></script>
</body>
</html>
