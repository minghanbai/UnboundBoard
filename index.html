<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unbound Board</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; overflow: hidden; }
        
        /* éš±è—åŸå§‹ Toolbarï¼Œä½†ä¿ç•™ ID ä¾› JS é‚è¼¯æ§åˆ¶é¡¯ç¤ºç‹€æ…‹ */
        #toolbar { display: none; position: absolute; top: -9999px; visibility: hidden; }
        
        #canvas-container { 
            flex: 1; background: #e0e0e0; position: relative; 
            display: flex; 
            overflow: auto; 
        }
        
        /* é€šç”¨æ‡¸æµ®å·¥å…·åˆ—æ¨£å¼ */
        .floating-toolbar {
            display: none; /* åˆå§‹éš±è—ï¼Œé€é JS èˆ‡ä¸Šæ–¹å·¥å…·åˆ—åŒæ­¥ */
            flex-direction: row; gap: 8px; align-items: center;
            background: white; padding: 8px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100;
            position: absolute;
        }

        /* å„å€å¡Šä½ç½® */
        #top-left-toolbar { top: 20px; left: 20px; }
        #top-right-toolbar { top: 20px; right: 20px; }
        #view-toolbar { bottom: 30px; left: 20px; }
        #left-toolbar { bottom: 30px; left: 50%; transform: translateX(-50%); padding: 8px 15px; gap: 12px; }

        /* æŒ‰éˆ•æ¨£å¼å¾®èª¿ */
        .floating-toolbar button {
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid transparent;
            background: transparent; font-size: 1.4em; padding: 0;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s ease;
        }
        .floating-toolbar button:hover { background: #f1f3f5; transform: scale(1.05); }
        .floating-toolbar button.active { background: #e7f5ff; color: #007bff; border-color: #007bff; }
        
        /* ç‹€æ…‹æ–‡å­—æ¨£å¼ */
        #status { font-size: 0.85em; color: #666; margin-left: 5px; white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }

        /* Fabric.js ç”¢ç”Ÿçš„ç•«å¸ƒå®¹å™¨æ¨£å¼ */
        .canvas-container { background: white; box-shadow: 0 0 15px rgba(0,0,0,0.15); margin: 50px auto; }

        button { cursor: pointer; padding: 5px 10px; display: inline-flex; align-items: center; gap: 5px; justify-content: center; }
        .lucide { width: 20px; height: 20px; }
        .active { background: #007bff; color: white; border: none; }
        #overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; color: white; font-size: 1.5em;
            pointer-events: auto;
            backdrop-filter: blur(2px);
        }
        .hidden { display: none !important; pointer-events: none !important; }
        .tag { font-size: 0.8em; padding: 2px 5px; border-radius: 3px; color: white; margin-left: 5px; }
        .tag-host { background: #ffc107; color: black; }
        .tag-me { background: #28a745; }
        #side-panel {
            position: absolute; bottom: 10px; right: 10px;
            background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 320px; height: 450px; z-index: 900; border-radius: 5px;
            display: flex; flex-direction: column;
        }
        #panel-header { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; border-radius: 5px 5px 0 0; }
        .panel-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; color: #666; font-weight: bold; }
        .panel-tab.active { border-bottom: 2px solid #007bff; color: #007bff; background: white; }
        .panel-close { padding: 0 15px; border: none; background: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .tab-content { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        #chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #fff; }
        #chat-input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; background: #fff; }
        #chat-input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; background: #f0f2f5; outline: none; }
        #chat-input:focus { border-color: #007bff; background: #fff; }
        #btn-chat-send { border-radius: 20px !important; }
        
        .chat-msg { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 2px; }
        .chat-msg.self { align-self: flex-end; align-items: flex-end; }
        .chat-msg.other { align-self: flex-start; align-items: flex-start; }
        .chat-name { font-size: 0.75em; color: #65676b; margin-bottom: 4px; margin-left: 12px; }
        .chat-msg.self .chat-name { display: none; }
        .chat-bubble { padding: 8px 14px; border-radius: 18px; font-size: 0.95em; line-height: 1.4; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-msg.self .chat-bubble { background: #007bff; color: white; border-bottom-right-radius: 4px; }
        .chat-msg.other .chat-bubble { background: #f0f2f5; color: #050505; border-bottom-left-radius: 4px; }
        .has-unread { position: relative; }
        .has-unread::after { content: "â—"; color: red; position: absolute; top: 0; right: 0; font-size: 10px; }
        #user-list-content { flex: 1; overflow-y: auto; padding: 0; }
        .user-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #toast-container {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 2000; pointer-events: none;
        }
        .toast {
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 0.9em; animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        #landing-modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center; width: 300px;
        }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #666; font-weight: bold; }
        .input-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; }
        .primary-btn { background: #007bff; color: white; width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1.1em; cursor: pointer; }
        .secondary-btn { background: #6c757d; color: white; width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1.1em; cursor: pointer; margin-top: 5px;}
        .divider { margin: 20px 0; color: #999; font-size: 0.9em; position: relative; }
        .divider::before, .divider::after { content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background: #eee; }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        #context-menu {
            display: none; position: absolute; z-index: 3000; background: white; 
            border: 1px solid #ccc; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden;
        }
        #youtube-wrapper {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 640px; height: 390px; background: black; z-index: 2500;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 4px solid #333; border-radius: 8px;
            display: flex; flex-direction: column;
        }
        #yt-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: transparent; }
        
        .color-preset.active {
            border: 2px solid #007bff !important;
            transform: scale(1.1);
        }
        
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .blink { animation: blink 1s infinite ease-in-out; }
    </style>
</head>
<body>

<!-- éš±è—çš„åŸå§‹ Toolbarï¼Œç”¨æ–¼ç¶­æŒ JS é‚è¼¯ç›¸å®¹æ€§ -->
<div id="toolbar">
</div>

<!-- å·¦ä¸Šï¼šç³»çµ±èˆ‡æª”æ¡ˆ -->
<div id="top-left-toolbar" class="floating-toolbar">
    <button onclick="toggleSettings()" id="btn-settings" style="display:none;" title="è¨­å®š"><i data-lucide="settings"></i></button>
    <button onclick="clearCanvas()" id="btn-clear" title="æ¸…ç©ºç•«å¸ƒ"><i data-lucide="trash-2"></i></button>
    <button onclick="copyLink()" style="color: #28a745;" title="è¤‡è£½åˆ†äº«é€£çµ"><i data-lucide="link"></i></button>
    <div id="pdf-controls" style="display:none; border-left: 1px solid #ccc; padding-left: 10px; margin-left: 10px; align-items: center; gap: 5px;">
        <button onclick="changePdfPage(-1)" id="btn-pdf-prev" title="ä¸Šä¸€é "><i data-lucide="chevron-left"></i></button>
        <span id="pdf-page-indicator" style="font-size: 0.9em; font-weight: bold; color: #333;"></span>
        <button onclick="changePdfPage(1)" id="btn-pdf-next" title="ä¸‹ä¸€é "><i data-lucide="chevron-right"></i></button>
        <button id="btn-return-live" onclick="returnToLive()" style="display:none; font-size: 0.8em; background: #17a2b8; color: white; border:none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">å›åˆ°åŒæ­¥</button>
        <button onclick="closePdfMode()" style="color:#dc3545;" class="host-only" title="çµæŸ PDF æ¨¡å¼"><i data-lucide="x"></i></button>
    </div>
    <span id="status"></span>
</div>

<!-- å³ä¸Šï¼šå”ä½œ (èˆ‰æ‰‹ã€æˆå“¡ã€èŠå¤©) -->
<div id="top-right-toolbar" class="floating-toolbar">
    <button onclick="copyLink()" style="color: #28a745;" title="è¤‡è£½åˆ†äº«é€£çµ"><i data-lucide="link"></i></button>
    <button onclick="toggleHand()" id="btn-hand" title="èˆ‰æ‰‹"><i data-lucide="hand"></i></button>
    <button onclick="toggleSidePanel('users')" id="btn-users" title="æˆå“¡åˆ—è¡¨" style="position: relative;">
        <i data-lucide="users"></i>
        <div id="user-status-indicator" style="position: absolute; top: -3px; right: -3px; display: flex; align-items: center; justify-content: center;"></div>
        <span id="user-count-badge" style="position: absolute; bottom: 2px; left: 2px; font-size: 10px; background: #6c757d; color: white; padding: 1px 3px; border-radius: 4px; line-height: 1; min-width: 6px;">1</span>
    </button>
    <button onclick="toggleSidePanel('chat')" id="btn-chat" title="èŠå¤©å®¤"><i data-lucide="message-square"></i></button>
</div>

<!-- å·¦ä¸‹ï¼šæª¢è¦– (ç¸®æ”¾) -->
<div id="view-toolbar" class="floating-toolbar">
    <button onclick="zoomCanvas(1.1)" title="æ”¾å¤§"><i data-lucide="zoom-in"></i></button>
    <button onclick="zoomCanvas(0.9)" title="ç¸®å°"><i data-lucide="zoom-out"></i></button>
    <button onclick="fitCanvasToWindow()" title="é©æ‡‰è¦–çª—"><i data-lucide="maximize"></i></button>
</div>

<!-- ä¸‹æ–¹ç½®ä¸­ï¼šç¹ªåœ–å·¥å…· -->
<div id="left-toolbar" class="floating-toolbar">
    <button onclick="setMode('select')" id="btn-select" title="ç§»å‹•/é¸å–"><i data-lucide="mouse-pointer-2"></i></button>
    <button onclick="setMode('pan')" id="btn-pan" title="æŠ“æ‰‹å·¥å…· (ç©ºç™½éµ)"><i data-lucide="grab"></i></button>
    <button onclick="setMode('pencil')" id="btn-pencil" title="ç•«ç­†"><i data-lucide="pencil"></i></button>
    <button onclick="addStickyNote()" id="btn-note" title="ä¾¿æ¢ç´™"><i data-lucide="sticky-note"></i></button>
    <button onclick="document.getElementById('img-upload').click()" id="btn-img" title="ä¸Šå‚³åœ–ç‰‡"><i data-lucide="image"></i></button>
    <input type="file" id="img-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
    <button onclick="startPdfUpload()" id="btn-pdf" title="ä¸Šå‚³ PDF"><i data-lucide="file-text"></i></button>
    <input type="file" id="pdf-upload" accept="application/pdf" style="display: none;" onchange="handlePdfUpload(this)">
    <button onclick="startYoutubePrompt()" id="btn-youtube" title="YouTube"><i data-lucide="youtube"></i></button>
    <button onclick="clearCanvas()" id="btn-clear" title="æ¸…ç©ºç•«å¸ƒ" style="color: #dc3545;"><i data-lucide="trash-2"></i></button>
</div>

<!-- ç•«ç­†è¨­å®šå·¥å…·åˆ— (åƒ…åœ¨ç•«ç­†æ¨¡å¼é¡¯ç¤º) -->
<div id="brush-toolbar" class="floating-toolbar" style="bottom: 90px; left: 50%; transform: translateX(-50%); padding: 8px 15px; gap: 12px; display: none;">
    <div style="display: flex; gap: 2px; margin-right: 5px; padding-right: 8px; border-right: 1px solid #eee;">
        <button id="btn-tool-pencil" title="é‰›ç­†" style="width:32px; height:32px;"><i data-lucide="pencil" style="width: 18px; height: 18px;"></i></button>
        <button id="btn-tool-highlighter" title="è¢å…‰ç­†" style="width:32px; height:32px;"><i data-lucide="highlighter" style="width: 18px; height: 18px;"></i></button>
        <button id="btn-tool-eraser" title="æ©¡çš®æ“¦" style="width:32px; height:32px;"><i data-lucide="eraser" style="width: 18px; height: 18px;"></i></button>
    </div>

    <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 2px; height: 2px; background: #333; border-radius: 50%;"></div>
        <input type="range" id="brush-size" min="1" max="20" value="5" style="width: 100px; cursor: pointer;" title="ç­†åˆ·å¤§å°">
        <div style="width: 20px; height: 20px; background: #333; border-radius: 50%;"></div>
    </div>
    <div style="width: 1px; height: 24px; background: #eee; margin: 0 5px;"></div>
    <div style="display: flex; gap: 5px; align-items: center;">
        <div class="color-preset active" data-index="0" style="cursor:pointer; width:24px; height:24px; border-radius:50%; border:1px solid #ddd;"></div>
        <div class="color-preset" data-index="1" style="cursor:pointer; width:24px; height:24px; border-radius:50%; border:1px solid #ddd;"></div>
        <div class="color-preset" data-index="2" style="cursor:pointer; width:24px; height:24px; border-radius:50%; border:1px solid #ddd;"></div>
        <div class="color-preset" data-index="3" style="cursor:pointer; width:24px; height:24px; border-radius:50%; border:1px solid #ddd;"></div>
        <div class="color-preset" data-index="4" style="cursor:pointer; width:24px; height:24px; border-radius:50%; border:1px solid #ddd;"></div>
        <div class="color-preset" data-index="5" style="cursor:pointer; width:24px; height:24px; border-radius:50%; border:1px solid #ddd;"></div>
        <div style="position: relative; width: 24px; height: 24px; border-radius: 50%; overflow: hidden; border: 1px solid #ddd; cursor: pointer; background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); display: flex; justify-content: center; align-items: center;" title="è‡ªè¨‚é¡è‰²">
             <div id="brush-color-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #000000; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.3); pointer-events: none; display: none;"></div>
             <input type="color" id="brush-color-picker" style="opacity: 0; width: 100%; height: 100%; cursor: pointer; padding: 0; border: none; position: absolute; top: 0; left: 0;">
        </div>
    </div>
</div>

<div id="canvas-container">
    <canvas id="c"></canvas>
    <div id="overlay" class="hidden">
        <div id="overlay-msg">é€£ç·šä¸­...</div>
    </div>
    <div id="youtube-wrapper" class="hidden">
        <div id="yt-player"></div>
        <div id="yt-blocker" style="display:none;"></div>
        <div id="guest-yt-controls" style="display:none; position: absolute; top: -35px; right: 0; z-index: 20; align-items: center; gap: 5px;">
            <button id="btn-guest-play" onclick="ytGuestPlay()" style="background: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold;"><i data-lucide="play"></i> é»æ­¤æ’­æ”¾</button>
            <button onclick="ytToggleMute()" style="background: #6c757d; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold;"><i data-lucide="volume-2"></i> è²éŸ³</button>
        </div>
        <button id="btn-close-yt" onclick="closeYoutube()" style="position: absolute; top: -35px; right: 0; background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold;"><i data-lucide="x"></i> é—œé–‰åŒæ­¥</button>
    </div>
    <div id="toast-container"></div>
    <div id="side-panel" class="hidden">
        <div id="panel-header">
            <div id="tab-chat" class="panel-tab active" onclick="switchTab('chat')">èŠå¤©å®¤</div>
            <div id="tab-users" class="panel-tab" onclick="switchTab('users')">æˆå“¡</div>
            <button class="panel-close" onclick="document.getElementById('side-panel').classList.add('hidden')">Ã—</button>
        </div>
        <div id="panel-chat" class="tab-content active">
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯...">
                <button onclick="sendChatMessage()" class="primary-btn" style="width:auto; padding: 5px 15px; font-size: 0.9em;" id="btn-chat-send">é€å‡º</button>
            </div>
        </div>
        <div id="panel-users" class="tab-content">
            <div id="user-list-content"></div>
        </div>
    </div>
    <div id="settings-modal" class="hidden" style="position: absolute; top: 50px; left: 10px; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px; width: 200px; z-index: 950; border-radius: 5px;">
        <h3 style="margin-top:0;">æˆ¿é–“è¨­å®š</h3>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-hand">å…è¨±èˆ‰æ‰‹</label>
            <input type="checkbox" id="setting-hand" checked onchange="updateSettings()">
        </div>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-chat">å…è¨±èŠå¤©</label>
            <input type="checkbox" id="setting-chat" checked onchange="updateSettings()">
        </div>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <label for="setting-edit">å…è¨±ç·¨è¼¯</label>
            <input type="checkbox" id="setting-edit" checked onchange="updateSettings()">
        </div>
        <button onclick="toggleSettings()" class="secondary-btn" style="font-size: 0.9em; padding: 5px;">é—œé–‰</button>
    </div>
    <div id="landing-modal" class="hidden">
        <div class="modal-content">
            <h2>Unbound Board</h2>
            <div class="input-group">
                <label>æ‚¨çš„æš±ç¨±</label>
                <input type="text" id="nickname-input" placeholder="è¼¸å…¥æš±ç¨±">
            </div>
            <div class="action-group">
                <button onclick="createRoom()" class="primary-btn">ğŸ  é–‹æ–°æˆ¿é–“</button>
            </div>
            <div class="divider">æˆ–è€…</div>
            <div class="input-group">
                <label>è¼¸å…¥æˆ¿é–“ä»£ç¢¼</label>
                <input type="text" id="room-code-input" placeholder="ä¾‹å¦‚: board-xyz...">
                <button onclick="joinRoomInput()" class="secondary-btn">â¡ï¸ åŠ å…¥æˆ¿é–“</button>
            </div>
        </div>
    </div>
</div>

<div id="context-menu">
    <div style="padding:8px 15px; cursor:pointer; font-size: 0.9em; color: #dc3545; display: flex; align-items: center; gap: 5px;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="deleteSelectedObject()"><i data-lucide="trash-2" style="width:16px;height:16px;"></i> åˆªé™¤</div>
</div>
<script src="globals.js"></script>
<script src="drawing.js"></script>
<script src="connection.js"></script>
<script>
    // åŒæ­¥æ‰€æœ‰æ‡¸æµ®å·¥å…·åˆ—èˆ‡éš±è—çš„ #toolbar é¡¯ç¤ºç‹€æ…‹
    // å› ç‚ºåŸæœ¬çš„é‚è¼¯å¯èƒ½æœƒæ§åˆ¶ #toolbar çš„ display å±¬æ€§
    const toolbar = document.getElementById('toolbar');
    const floatingToolbars = document.querySelectorAll('.floating-toolbar');

    function syncToolbars() {
        const isVisible = getComputedStyle(toolbar).display !== 'none';
        floatingToolbars.forEach(el => {
            if (el.id === 'brush-toolbar') {
                if (!isVisible) el.style.display = 'none';
                else if (typeof currentMode !== 'undefined' && (currentMode === 'pencil' || currentMode === 'eraser')) el.style.display = 'flex';
                return;
            }
            el.style.display = isVisible ? 'flex' : 'none';
        });
    }

    if (toolbar) {
        syncToolbars(); // åˆå§‹åŒæ­¥
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                    syncToolbars();
                }
            });
        });
        observer.observe(toolbar, { attributes: true });
    }
    
    // åˆå§‹åŒ– Lucide åœ–æ¨™
    lucide.createIcons();
</script>
</body>
</html>
